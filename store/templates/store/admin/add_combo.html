{% extends 'store/base.html' %}
{% load currency %}

{% block content %}
<style>
  /* Theme-matched confirmation modal */
  .confirm-modal .modal-content {
    border-radius: 18px;
    background: var(--card-bg);
    border: 1px solid rgba(30, 136, 229, 0.28);
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
    color: var(--text-white);
  }
  .confirm-modal .modal-header,
  .confirm-modal .modal-footer {
    border-color: rgba(255, 255, 255, 0.08);
  }
  .confirm-modal .combo-name {
    display: inline;
    font-weight: 600;
    color: var(--dark-text);
  }
  html[data-theme='light'] .confirm-modal .modal-content {
    background: var(--light-card);
    color: var(--light-text);
    border-color: rgba(27, 36, 48, 0.16);
    box-shadow: 0 18px 45px rgba(15, 45, 88, 0.25);
  }
  html[data-theme='light'] .confirm-modal .modal-header,
  html[data-theme='light'] .confirm-modal .modal-footer {
    border-color: rgba(27, 36, 48, 0.1);
  }
  html[data-theme='light'] .confirm-modal .combo-name {
    color: var(--light-text);
  }
</style>
<section class="section">
  <div class="container">
    <h2 class="section-heading">{% if editing %}Edit Combo{% else %}Add Combo{% endif %}</h2>
    {% if errors %}
      <div class="alert alert-danger">{% for e in errors %}<div>{{ e }}</div>{% endfor %}</div>
    {% endif %}

    <form method="post" action="{% if editing %}{% url 'admin_edit_combo' combo.id %}{% else %}{% url 'admin_add_combo' %}{% endif %}">
      {% csrf_token %}
      <!-- Combo styles moved to global stylesheet: static/css/style.css -->
      <div class="mb-3">
        <label class="form-label">Title</label>
        <input name="title" class="form-control" value="{% if editing %}{{ combo.title }}{% else %}{{ title|default:'' }}{% endif %}" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Bundle Price (optional)</label>
        <input name="bundle_price" class="form-control" value="{% if editing %}{{ combo.bundle_price }}{% else %}{{ bundle_price|default:'' }}{% endif %}" placeholder="e.g. 999.00" />
      </div>
      <div class="mb-3">
        <label class="form-label">Category</label>
        <select name="category_id" class="form-select" required>
          <option value="">-- select category --</option>
          {% for category in categories %}
            <option value="{{ category.id }}"
              {% if selected_category_id %}
                {% if category.id|stringformat:'s' == selected_category_id|stringformat:'s' %}selected{% endif %}
              {% elif editing and combo %}
                {% if category.id == combo.category_id %}selected{% endif %}
              {% endif %}
            >{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-check mb-3">
        <input type="checkbox" name="is_active" id="is_active" class="form-check-input" {% if editing %}{% if combo.is_active %}checked{% endif %}{% else %}{% if is_active %}checked{% endif %}{% endif %} />
        <label for="is_active" class="form-check-label">Active</label>
      </div>
      <div class="form-check mb-3">
        <input type="checkbox" name="show_on_homepage" id="show_on_homepage" class="form-check-input" {% if editing %}{% if combo.show_on_homepage %}checked{% endif %}{% else %}{% if show_on_homepage %}checked{% endif %}{% endif %} />
        <label for="show_on_homepage" class="form-check-label">Show on homepage</label>
      </div>
      {# Removed: show_in_limited_offers checkbox - combos are not shown in Limited Offers banner anymore #}

      <h5>Items</h5>
      <div id="combo-items">
        {% if editing and combo.items.all %}
          {% for item in combo.items.all %}
            <div class="row combo-item mb-2">
              <div class="col-md-8">
                <select name="fish_id" class="form-select combo-select">
                  <option value="">-- select fish --</option>
                  {% for fish in fishes %}
                    <option value="{{ fish.id }}" {% if fish.id == item.fish.id %}selected{% endif %}>{{ fish.name }} ({{ fish.price|rupees }})</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <input type="number" name="quantity" class="form-control combo-qty" value="{{ item.quantity }}" min="1" />
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
              </div>
            </div>
          {% endfor %}
        {% else %}
          {% if prefill_fish_ids %}
            {% for pfid in prefill_fish_ids %}
              <div class="row combo-item mb-2">
                <div class="col-md-8">
                  <select name="fish_id" class="form-select combo-select">
                    <option value="">-- select fish --</option>
                    {% for fish in fishes %}
                      <option value="{{ fish.id }}" {% if fish.id == pfid %}selected{% endif %}>{{ fish.name }} ({{ fish.price|rupees }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <input type="number" name="quantity" class="form-control combo-qty" value="1" min="1" />
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-danger remove-item">Remove</button>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="row combo-item mb-2">
              <div class="col-md-8">
                <select name="fish_id" class="form-select combo-select">
                  <option value="">-- select fish --</option>
                  {% for fish in fishes %}
                    <option value="{{ fish.id }}">{{ fish.name }} ({{ fish.price|rupees }})</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <input type="number" name="quantity" class="form-control combo-qty" value="1" min="1" />
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
              </div>
            </div>
          {% endif %}
        {% endif %}
      </div>

      <div class="mb-3">
        <button type="button" id="add-item" class="btn btn-secondary">Add another fish</button>
      </div>

      <div>
        <button class="btn btn-primary">{% if editing %}Update Combo{% else %}Create Combo{% endif %}</button>
        <a href="{% url 'admin_fishes' %}" class="btn btn-light">Cancel</a>
        {% if editing %}
          <a href="{% url 'admin_add_combo' %}" class="btn btn-outline-secondary ms-2">New Combo</a>
        {% endif %}
      </div>
    </form>
    
    <hr />
    <h5>Existing combo</h5>
    {% if combos and combos|length > 0 %}
      <div class="list-group mb-4">
        {% for c in combos %}
          <div class="list-group-item d-flex justify-content-between align-items-center combo-list-item{% if not c.is_active %} combo-inactive{% endif %}">
            <div>
              <strong>{{ c.title }}</strong>
              {% if c.bundle_price %}<div class="text-muted">{{ c.bundle_price|rupees }}</div>{% endif %}
                {% if c.items.all %}
                <div class="small combo-items-list">
                  {% for it in c.items.all %}
                    <span class="combo-fish-name small">{{ it.fish.name }}</span>{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
              <div class="small text-muted">{{ c.items.count }} items{% if not c.is_active %} â€” inactive{% endif %}</div>
            </div>
            <div>
              <a href="{% url 'admin_edit_combo' c.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
              <form method="post" action="{% url 'admin_delete_combo' c.id %}" style="display:inline; margin-left:8px;" class="combo-delete-form" data-combo-name="{{ c.title }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No combos created yet.</p>
    {% endif %}
  </div>
</section>

<!-- Delete confirmation modal -->
<div class="modal fade confirm-modal" id="deleteComboModal" tabindex="-1" aria-labelledby="deleteComboModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteComboModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">This action cannot be undone. Delete <span class="combo-name">selected combo</span>?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteCombo">Delete Combo</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const items = document.getElementById('combo-items');
  const addBtn = document.getElementById('add-item');

    function makeRow(){
    const row = document.createElement('div');
    row.className = 'row combo-item mb-2';
    row.innerHTML = `
      <div class="col-md-8">
        <select name="fish_id" class="form-select combo-select">
          <option value="">-- select fish --</option>
          {% for fish in fishes %}
            <option value="{{ fish.id }}">{{ fish.name }} ({{ fish.price|rupees }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" name="quantity" class="form-control combo-qty" value="1" min="1" />
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-danger remove-item">Remove</button>
      </div>
    `;
    return row;
  }

  addBtn.addEventListener('click', function(){
    items.appendChild(makeRow());
  });

  items.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('remove-item')){
      const row = e.target.closest('.combo-item');
      if(row) row.remove();
    }
  });
})();

document.addEventListener('DOMContentLoaded', function(){
  const deleteModalEl = document.getElementById('deleteComboModal');
  const confirmDeleteBtn = document.getElementById('confirmDeleteCombo');
  if (!deleteModalEl || !confirmDeleteBtn) {
    return;
  }

  const bootstrapModal = new bootstrap.Modal(deleteModalEl, { backdrop: 'static' });
  const comboNameTarget = deleteModalEl.querySelector('.combo-name');
  let formPendingSubmission = null;

  document.querySelectorAll('.combo-delete-form').forEach(function(form){
    form.addEventListener('submit', function(evt){
      if (form.dataset.deleteConfirmed === 'true') {
        form.dataset.deleteConfirmed = '';
        return;
      }

      evt.preventDefault();
      formPendingSubmission = form;
      const comboName = form.getAttribute('data-combo-name') || 'this combo';
      if (comboNameTarget) {
        comboNameTarget.textContent = comboName;
      }
      bootstrapModal.show();
    });
  });

  confirmDeleteBtn.addEventListener('click', function(){
    if (formPendingSubmission) {
      formPendingSubmission.dataset.deleteConfirmed = 'true';
      formPendingSubmission.submit();
      bootstrapModal.hide();
      formPendingSubmission = null;
    }
  });

  deleteModalEl.addEventListener('hidden.bs.modal', function(){
    if (formPendingSubmission) {
      formPendingSubmission = null;
    }
  });
});
</script>

{% endblock %}
