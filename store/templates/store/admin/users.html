{% extends 'store/base.html' %}

{% block extra_css %}
<style>
    /* Scoped styles for user management page (dark mode only) */
    html[data-theme='dark'] .user-management .card {
        background: var(--card-bg) !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: 0 0 20px rgba(0,100,200,0.15) !important;
    }
    
    /* Table styling */
    html[data-theme='dark'] .user-management .table>:not(caption)>*>*:not(.btn):not(.badge) {
        background: transparent !important;
        box-shadow: none !important;
        color: #FFFFFF !important;
        border-color: rgba(255,255,255,0.1) !important;
    }
    
    /* Table headers */
    html[data-theme='dark'] .user-management thead th {
        background: rgba(25,40,60,0.65) !important;
        color: #FFFFFF !important;
        font-weight: 600 !important;
        border-bottom: 2px solid rgba(255,255,255,0.15) !important;
    }
    
    /* Table rows */
    html[data-theme='dark'] .user-management tbody tr {
        background: rgba(20,30,45,0.55) !important;
        transition: background 0.2s ease;
    }
    
    html[data-theme='dark'] .user-management tbody tr:nth-child(odd) {
        background: rgba(25,40,60,0.55) !important;
    }
    
    html[data-theme='dark'] .user-management tbody tr:hover {
        background: rgba(40,80,140,0.55) !important;
    }
    
    /* Table cells */
    html[data-theme='dark'] .user-management .table tbody td {
        color: #FFFFFF !important;
    }
    
    html[data-theme='dark'] .user-management .table tbody td *:not(.btn):not(.badge) {
        color: #FFFFFF !important;
    }
    
    html[data-theme='dark'] .user-management .table tbody td strong {
        color: #FFFFFF !important;
        font-weight: 700;
    }
    
    /* Override admin-text-black class */
    html[data-theme='dark'] .user-management .admin-text-black {
        color: #FFFFFF !important;
    }
    
    /* Favorite heart icon styling */
    .favorite-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 0.25rem 0.5rem;
    }
    
    .favorite-btn.active {
        color: #FF1744;
        text-shadow: 0 0 10px rgba(255, 23, 68, 0.5);
    }
    
    .favorite-btn.inactive {
        color: rgba(255, 255, 255, 0.3);
    }
    
    .favorite-btn:hover {
        transform: scale(1.2);
    }
    
    html[data-theme='light'] .favorite-btn.inactive {
        color: rgba(0, 0, 0, 0.3);
    }

    .user-management #userSearch.is-loading {
        padding-right: 2.75rem;
    }

    .user-management .search-spinner {
        right: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<section class="section user-management">
    <div class="container-fluid">
        <h2 class="section-heading">User Management</h2>
        <div class="card admin-card-light mb-3">
            <div class="card-body d-flex flex-column flex-md-row align-items-center gap-3">
                <div class="flex-shrink-0">
                    <h5 class="mb-0">Search Users</h5>
                </div>
                <div class="ms-md-auto w-100 w-md-50 position-relative">
                    <input type="search" id="userSearch" class="form-control" placeholder="Search users..." autocomplete="off">
                    <span class="search-spinner spinner-border spinner-border-sm text-primary position-absolute top-50 end-2 translate-middle-y d-none" role="status" aria-hidden="true"></span>
                </div>
            </div>
        </div>

        <div id="usersTableContainer">
            {% include 'store/admin/_users_table.html' with users=users %}
        </div>
    </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('userSearch');
    const container = document.getElementById('usersTableContainer');
    const spinner = document.querySelector('.search-spinner');
    if (!searchInput || !container) {
        return;
    }

    let activeRequest = null;
    let debounceTimer = null;

    function setLoading(isLoading) {
        if (spinner) {
            spinner.classList.toggle('d-none', !isLoading);
        }
        searchInput.classList.toggle('is-loading', isLoading);
    }

    function fetchUsers(query) {
        if (activeRequest) {
            activeRequest.abort();
            activeRequest = null;
        }

        setLoading(true);
        const controller = new AbortController();
        activeRequest = controller;

        const url = new URL('{% url "admin_users_ajax" %}', window.location.origin);
        if (query) {
            url.searchParams.set('search', query);
        }

        fetch(url.toString(), {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            signal: controller.signal,
        }).then(function(response) {
            if (!response.ok) { throw new Error('Network error'); }
            return response.json();
        }).then(function(data) {
            if (data && typeof data.html === 'string') {
                container.innerHTML = data.html;
            }
        }).catch(function(error) {
            if (error.name !== 'AbortError') {
                console.error('User search failed', error);
            }
        }).finally(function() {
            if (activeRequest === controller) {
                activeRequest = null;
                setLoading(false);
            }
        });
    }

    searchInput.addEventListener('input', function(event) {
        const value = event.target.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
            fetchUsers(value);
        }, 250);
    });
});
</script>
{% endblock %}
