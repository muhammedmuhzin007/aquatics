{% extends "store/base.html" %}
{% load static %}
{% block title %}Accessories{% endblock %}

{% block content %}
<div class="container py-4">
  {% if accessories and accessories|length > 0 %}
    <div class="mb-4">
      <h2 class="mb-2">Accessories</h2>
      <form id="accessory-filter-form" class="mb-3">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-8 col-lg-9">
            <label for="accessory-search" class="form-label text-muted mb-1">Search accessories</label>
            <input id="accessory-search" type="text" class="form-control form-control-lg search-large" name="q" value="{{ search_query }}" placeholder="Search accessories" autocomplete="off">
          </div>
          <div class="col-12 col-md-4 col-lg-3">
            <label for="accessory-category" class="form-label text-muted mb-1">Category</label>
            <select id="accessory-category" name="category" class="form-select form-select-lg">
              <option value=""{% if not selected_category %} selected{% endif %}>All</option>
              {% for category in categories %}
              <option value="{{ category.id }}"{% if selected_category and category.id|stringformat:"s" == selected_category|stringformat:"s" %} selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </form>
    </div>

    <div id="accessory-results">
      <div id="accessory-grid">
        <div class="row">
          {% for accessory in accessories %}
          <div class="col-md-4 mb-4">
            <div class="card h-100" data-href="{% url 'accessory_detail' accessory.id %}" role="button" tabindex="0">
              {% if accessory.image %}
                <img src="{{ accessory.image.url }}" class="card-img-top" alt="{{ accessory.name }}">
              {% else %}
                <img src="{% static 'images/placeholder.png' %}" class="card-img-top" alt="{{ accessory.name }}">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ accessory.name }}</h5>
                <p class="card-text mb-3">â‚¹{{ accessory.price }}</p>
                <div class="mt-auto d-flex justify-content-end align-items-center">
                  <form method="post" action="{% url 'add_accessory_to_cart' accessory.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="btn btn-primary btn-sm">Add to Cart</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Pagination -->
      {% if accessories.has_other_pages %}
        <nav aria-label="Accessories pagination">
          <ul class="pagination justify-content-center mt-4">
            {% if accessories.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ accessories.previous_page_number }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">Previous</a>
              </li>
            {% endif %}

            {% for num in accessories.paginator.page_range %}
              {% if num == accessories.number %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if accessories.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ accessories.next_page_number }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">Next</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  {% endif %}
  <div class="mb-5" aria-hidden="true"></div>
</div>
{% endblock %}

{% block extra_js %}
  <style>
    /* Smooth replace animation for accessory results */
    #accessory-results {
      transition: opacity 220ms ease, transform 220ms ease;
      will-change: opacity, transform;
    }
    #accessory-results.fade-out {
      opacity: 0;
      transform: translateY(8px) scale(0.995);
    }
    #accessory-results.fade-in {
      opacity: 1;
      transform: none;
    }
  </style>

  <script>
// Adapted to fish-like working: debounce, fetch JSON partial from same path, insert results
(() => {
  const input = document.getElementById('accessory-search');
  const categorySelect = document.getElementById('accessory-category');
  const filterForm = document.getElementById('accessory-filter-form');
  if (!input) return;

  const resultsContainer = document.getElementById('accessory-results');
  const spinner = document.getElementById('accessory-search-spinner');
  let timeout = null;
  const delay = 300; // align with fish

  function insertResults(html) {
    if (!resultsContainer) return;
    // animate like before
    resultsContainer.classList.remove('fade-in');
    try { resultsContainer.classList.add('fade-out'); } catch (e) {}
    setTimeout(() => {
      resultsContainer.innerHTML = html;
      // force reflow
      void resultsContainer.offsetWidth;
      resultsContainer.classList.remove('fade-out');
      resultsContainer.classList.add('fade-in');
      setTimeout(() => resultsContainer.classList.remove('fade-in'), 300);
    }, 220);
  }

  async function fetchResults(query, category) {
    const params = new URLSearchParams();
    if (query) params.set('q', query);
    if (category) params.set('category', category);
    const qs = params.toString();
    const url = qs ? `${window.location.pathname}?${qs}` : window.location.pathname;
    try {
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
      if (resp.redirected && resp.url && resp.url.includes('/login')) { window.location = resp.url; return; }
      if (!resp.ok) return;
      const data = await resp.json();
      if (data && data.html !== undefined) {
        insertResults(data.html);
        if (window.history && window.history.replaceState) {
          window.history.replaceState(null, '', url);
        }
      }
    } catch (err) {
      console.error('Accessory live search error', err);
    } finally {
      // no loading UI changes (spinner/input disable) per request
    }
  }

  function currentFilters() {
    const query = input ? input.value.trim() : '';
    const category = categorySelect ? categorySelect.value : '';
    return { query, category };
  }

  if (input) {
    input.addEventListener('input', function() {
      const { query, category } = currentFilters();
      clearTimeout(timeout);
      timeout = setTimeout(() => fetchResults(query, category), delay);
    });

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        clearTimeout(timeout);
        const { query, category } = currentFilters();
        fetchResults(query, category);
      }
    });
  }

  function bindSelect(selectEl) {
    if (!selectEl) return;
    selectEl.addEventListener('change', function() {
      const { query, category } = currentFilters();
      fetchResults(query, category);
    });
  }

  bindSelect(categorySelect);

  if (filterForm) {
    filterForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const { query, category } = currentFilters();
      fetchResults(query, category);
    });
  }

  // Keep pagination interception for AJAX navigation
  document.body.addEventListener('click', function(e) {
    const a = e.target.closest && e.target.closest('#accessory-results .pagination a');
    if (!a) return;
    e.preventDefault();
    const href = a.getAttribute('href');
    if (!href) return;
    // Construct absolute URL relative to current path
    const url = new URL(href, window.location.href);
    // preserve current filters
    const { query, category } = currentFilters();
    url.searchParams.delete('q');
    url.searchParams.delete('category');
    if (query) url.searchParams.set('q', query);
    if (category) url.searchParams.set('category', category);
    // Use same fetchResults but with full query string
    (async () => {
      try {
        const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
        if (resp.redirected && resp.url && resp.url.includes('/login')) { window.location = resp.url; return; }
        if (!resp.ok) return;
        const data = await resp.json();
        if (data && data.html !== undefined) {
          insertResults(data.html);
          if (window.history && window.history.replaceState) {
            window.history.replaceState(null, '', url.toString());
          }
        }
      } catch (err) { console.error('Accessory pagination AJAX error', err); }
      finally { /* no spinner handling */ }
    })();
  });
})();
</script>
{% endblock %}
