{% extends "store/base.html" %}
{% load static %}
{% block title %}Accessories{% endblock %}

{% block content %}
<div class="container py-4">
  {% if accessories and accessories|length > 0 %}
    <div class="mb-4">
      <h2 class="mb-2">Accessories</h2>
      <div>
        <div class="row g-0">
          <div class="col-12">
            <input id="accessory-search" type="text" class="form-control form-control-lg search-large" name="q" value="{{ search_query }}" placeholder="Search accessories" autocomplete="off" style="width:100%;">
          </div>
        </div>
      </div>
    </div>

    <div id="accessory-results">
      <div id="accessory-grid">
        <div class="row">
          {% for accessory in accessories %}
          <div class="col-md-4 mb-4">
            <div class="card h-100" data-href="{% url 'accessory_detail' accessory.id %}" role="button" tabindex="0">
              {% if accessory.image %}
                <img src="{{ accessory.image.url }}" class="card-img-top" alt="{{ accessory.name }}">
              {% else %}
                <img src="{% static 'images/placeholder.png' %}" class="card-img-top" alt="{{ accessory.name }}">
              {% endif %}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ accessory.name }}</h5>
                <p class="card-text mb-3">â‚¹{{ accessory.price }}</p>
                <div class="mt-auto d-flex justify-content-end align-items-center">
                  <form method="post" action="{% url 'add_accessory_to_cart' accessory.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1">
                    <button type="submit" class="btn btn-primary btn-sm">Add to Cart</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Pagination -->
      {% if accessories.has_other_pages %}
        <nav aria-label="Accessories pagination">
          <ul class="pagination justify-content-center mt-4">
            {% if accessories.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ accessories.previous_page_number }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">Previous</a>
              </li>
            {% endif %}

            {% for num in accessories.paginator.page_range %}
              {% if num == accessories.number %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if accessories.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ accessories.next_page_number }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">Next</a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  {% endif %}
  <div class="mb-5" aria-hidden="true"></div>
</div>
{% endblock %}

{% block extra_js %}
  <style>
    /* Smooth replace animation for accessory results */
    #accessory-results {
      transition: opacity 220ms ease, transform 220ms ease;
      will-change: opacity, transform;
    }
    #accessory-results.fade-out {
      opacity: 0;
      transform: translateY(8px) scale(0.995);
    }
    #accessory-results.fade-in {
      opacity: 1;
      transform: none;
    }
  </style>

  <script>
// Adapted to fish-like working: debounce, fetch JSON partial from same path, insert results
(() => {
  const input = document.getElementById('accessory-search');
  if (!input) return;

  const resultsContainer = document.getElementById('accessory-results');
  const spinner = document.getElementById('accessory-search-spinner');
  let timeout = null;
  const delay = 300; // align with fish

  function insertResults(html) {
    if (!resultsContainer) return;
    // animate like before
    resultsContainer.classList.remove('fade-in');
    try { resultsContainer.classList.add('fade-out'); } catch (e) {}
    setTimeout(() => {
      resultsContainer.innerHTML = html;
      // force reflow
      void resultsContainer.offsetWidth;
      resultsContainer.classList.remove('fade-out');
      resultsContainer.classList.add('fade-in');
      setTimeout(() => resultsContainer.classList.remove('fade-in'), 300);
    }, 220);
  }

  async function fetchResults(query) {
    const params = new URLSearchParams({ q: query });
    const url = window.location.pathname + '?' + params.toString();
    try {
      const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
      if (resp.redirected && resp.url && resp.url.includes('/login')) { window.location = resp.url; return; }
      if (!resp.ok) return;
      const data = await resp.json();
      if (data && data.html !== undefined) insertResults(data.html);
    } catch (err) {
      console.error('Accessory live search error', err);
    } finally {
      // no loading UI changes (spinner/input disable) per request
    }
  }

  input.addEventListener('input', function(e) {
    const q = this.value.trim();
    clearTimeout(timeout);
    timeout = setTimeout(() => fetchResults(q), delay);
  });

  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); clearTimeout(timeout); fetchResults(this.value.trim()); }
  });

  // Keep pagination interception for AJAX navigation
  document.body.addEventListener('click', function(e) {
    const a = e.target.closest && e.target.closest('#accessory-results .pagination a');
    if (!a) return;
    e.preventDefault();
    const href = a.getAttribute('href');
    if (!href) return;
    // Construct absolute URL relative to current path
    const url = new URL(href, window.location.href);
    // preserve current input value
    const q = (input && input.value) ? input.value.trim() : '';
    if (q) url.searchParams.set('q', q);
    // Use same fetchResults but with full query string
    (async () => {
      try {
        const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
        if (resp.redirected && resp.url && resp.url.includes('/login')) { window.location = resp.url; return; }
        if (!resp.ok) return;
        const data = await resp.json();
        if (data && data.html !== undefined) insertResults(data.html);
      } catch (err) { console.error('Accessory pagination AJAX error', err); }
      finally { /* no spinner handling */ }
    })();
  });
})();
</script>
{% endblock %}
