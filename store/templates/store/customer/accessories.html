{% extends "store/base.html" %}
{% load static %}
{% block title %}Accessories{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Accessories</h2>
      <form class="d-flex" id="accessory-search-form" method="get" action="{% url 'accessories' %}">
      <input id="accessory-search" name="q" class="form-control form-control-lg me-2" placeholder="Search accessories" value="{{ search_query }}" style="min-width:340px; max-width:48%;">
        <div id="accessory-search-spinner" class="spinner-border spinner-border-sm text-primary ms-2 d-none" role="status" aria-hidden="true" title="Searching"></div>
    </form>
  </div>

  {% if accessories %}
  <div id="accessory-grid">
  <div class="row">
    {% for accessory in accessories %}
    <div class="col-md-4 mb-4">
      <div class="card h-100" data-href="{% url 'accessory_detail' accessory.id %}" role="button" tabindex="0">
        {% if accessory.image %}
          <img src="{{ accessory.image.url }}" class="card-img-top" alt="{{ accessory.name }}">
        {% else %}
          <img src="{% static 'images/placeholder.png' %}" class="card-img-top" alt="{{ accessory.name }}">
        {% endif %}
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ accessory.name }}</h5>
          
          <p class="card-text mb-3">₹{{ accessory.price }}</p>
          <div class="mt-auto d-flex justify-content-end align-items-center">
            <form method="post" action="{% url 'add_accessory_to_cart' accessory.id %}">
              {% csrf_token %}
              <input type="hidden" name="quantity" value="1">
              <button type="submit" class="btn btn-primary btn-sm">Add to Cart</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  </div>
  <!-- Pagination -->
  {% if accessories.has_other_pages %}
    <nav aria-label="Accessories pagination">
      <ul class="pagination justify-content-center mt-4">
        {% if accessories.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ accessories.previous_page_number }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">Previous</a>
          </li>
        {% endif %}

        {% for num in accessories.paginator.page_range %}
          {% if num == accessories.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if accessories.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ accessories.next_page_number }}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
  {% else %}
    <div class="alert alert-info">No accessories available.</div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Simple debounced AJAX search for accessories
(() => {
  const input = document.getElementById('accessory-search');
  if (!input) return;

  let timeout = null;
  const delay = 350; // ms

  async function doSearch(query) {
    const url = new URL(window.location.href);
    url.searchParams.set('q', query || '');
    url.searchParams.delete('page'); // reset to first page

    const spinner = document.getElementById('accessory-search-spinner');
    if (spinner) spinner.classList.remove('d-none');
    input.setAttribute('disabled', '');

    try {
      const resp = await fetch(url.toString(), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });

      // If the request was followed by a redirect to login, abort and let browser handle
      if (resp.redirected && resp.url && resp.url.includes('/login')) {
        // If redirected to login, reload the page so user can authenticate
        window.location = resp.url;
        return;
      }

      if (!resp.ok) return;

      // If server returns JSON with html, try to use it
      const ct = resp.headers.get('content-type') || '';
      let html = null;
      if (ct.includes('application/json')) {
        const data = await resp.json();
        html = data.html || null;
      } else {
        // fallback: full HTML page — extract #accessory-grid
        const text = await resp.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const grid = doc.querySelector('#accessory-grid');
        html = grid ? grid.innerHTML : null;
      }

      if (html !== null) {
        const container = document.getElementById('accessory-grid');
        if (container) container.innerHTML = html;
      }
    } catch (err) {
      console.error('Accessory search failed', err);
    } finally {
      if (spinner) spinner.classList.add('d-none');
      input.removeAttribute('disabled');
    }
  }

  input.addEventListener('input', (e) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => doSearch(e.target.value.trim()), delay);
  });

  // Also submit on Enter (prevent full page reload)
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(timeout);
      doSearch(e.target.value.trim());
    }
  });
})();
</script>
{% endblock %}
