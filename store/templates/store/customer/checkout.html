{% extends 'store/base.html' %}
{% load currency %}

{% block extra_css %}
<style>
    /* Center the checkout page content */
    .checkout-center .container-fluid {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* Payment Method Selection Styles */
    .payment-method-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .payment-option { position: relative; }
    .payment-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }
    .payment-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        min-height: 140px;
        justify-content: center;
    }
    /* Light theme base for payment tiles */
    html[data-theme='light'] .payment-card { background: var(--light-card); border-color: var(--light-border); }
    /* Hover state adapts to theme */
    html[data-theme='dark'] .payment-card:hover { background: rgba(255,255,255,0.05); border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(30,136,229,0.15); }
    html[data-theme='light'] .payment-card:hover { background: rgba(30,136,229,0.06); border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(30,136,229,0.10); }

    .payment-option input[type="radio"]:checked + .payment-card {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(30,136,229,0.2);
        background: linear-gradient(135deg, rgba(30,136,229,0.12), transparent);
    }
    .payment-card i { font-size: 2.5rem; color: var(--accent-blue); }
    .payment-card .payment-name { font-weight: 600; font-size: 1rem; text-align: center; color: var(--text-white); }
    .payment-card .payment-desc { font-size: 0.75rem; text-align: center; color: rgba(255,255,255,0.7); }
    html[data-theme='light'] .payment-card .payment-name { color: var(--light-text); }
    html[data-theme='light'] .payment-card .payment-desc { color: var(--light-text-soft, rgba(0,0,0,0.6)); }
    .payment-option input[type="radio"]:checked + .payment-card i { color: var(--accent-blue); animation: pulse 0.5s ease; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

    /* Themed form controls */
    .checkout-form .form-control,
    .checkout-form textarea.form-control {
        background: var(--card-bg) !important; /* dark default */
        border: 1px solid var(--border-color) !important;
        color: var(--text-white) !important;
        border-radius: 8px;
    }
    /* Light theme inputs should be bright surface with light borders/text */
    html[data-theme='light'] .checkout-form .form-control,
    html[data-theme='light'] .checkout-form textarea.form-control {
        background: var(--light-surface) !important;
        border-color: var(--light-border) !important;
        color: var(--light-text) !important;
    }
    .checkout-form .form-control::placeholder,
    .checkout-form textarea.form-control::placeholder { color: rgba(255,255,255,0.6) !important; }
    html[data-theme='light'] .checkout-form .form-control::placeholder,
    html[data-theme='light'] .checkout-form textarea.form-control::placeholder { color: var(--light-text-soft, rgba(0,0,0,0.5)) !important; }
    .checkout-form .form-control:focus,
    .checkout-form textarea.form-control:focus {
        background: var(--card-bg) !important;
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(30,136,229,0.15) !important;
    }
    .checkout-form .form-label { color: var(--text-white) !important; font-weight: 500; }
    html[data-theme='light'] .checkout-form .form-label { color: var(--light-text) !important; }

    /* Card header titles adapt to theme on checkout */
    html[data-theme='dark'] .checkout-center .card-header h5 { color: var(--text-white) !important; }
    html[data-theme='light'] .checkout-center .card-header h5 { color: var(--light-text) !important; }
    
    /* Coupon suggestion styles */
    .available-coupons {
        margin-top: 1rem;
    }
    
    .coupon-suggestion {
        background: rgba(102, 126, 234, 0.1);
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    /* Make coupon cards even height and align contents */
    .available-coupons .row > [class*="col-"] {
        display: flex; /* ensure columns stretch to same height */
    }
    .available-coupons .coupon-suggestion {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        min-height: 110px; /* consistent card height */
        box-sizing: border-box;
        padding: 1rem;
    }
    .available-coupons .coupon-suggestion > .d-flex {
        flex: 1 1 auto; /* let inner content take remaining space */
        align-items: center;
    }
    .available-coupons .coupon-suggestion .text-primary { font-size: 1.05rem; }
    
    html[data-theme='light'] .coupon-suggestion {
        background: rgba(102, 126, 234, 0.05);
        border-color: var(--light-border);
    }
    
    .coupon-suggestion:hover {
        background: rgba(102, 126, 234, 0.15);
        border-color: var(--accent-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    html[data-theme='light'] .coupon-suggestion:hover {
        background: rgba(102, 126, 234, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<section class="section checkout-center">
    <div class="container-fluid">
        <h2 class="section-heading text-center">Checkout</h2>

        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8 col-xl-7 mb-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="text-white"><i class="fas fa-shopping-cart"></i> Order Summary</h5>
                    </div>
                    <div class="card-body" id="order-summary-body" data-total="{{ total }}">
                        {% for item in cart_items %}
                        <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 1px solid var(--border-color);">
                            <div>
                                <strong class="text-white">{{ item.fish.name }}</strong><br>
                                <small class="text-gray">{{ item.fish.breed.name }} × {{ item.quantity }}</small>
                            </div>
                            <strong class="text-white">{{ item.get_total|rupees }}</strong>
                        </div>
                        {% endfor %}
                        <div class="d-flex justify-content-between mt-3 pt-3" style="border-top: 2px solid var(--border-color);">
                            <h6 class="text-white">Subtotal:</h6>
                            <h6 class="text-white">{{ total|rupees }}</h6>
                        </div>
                        {% if applied_coupon %}
                        <div class="d-flex justify-content-between text-success">
                            <span id="discount-label"><i class="fas fa-tag me-1"></i>Coupon <strong>{{ applied_coupon.code }}</strong> ({{ applied_coupon.discount_percentage }}%):</span>
                            <span id="discount-amount">{{ discount|rupees }}</span>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mt-2">
                            <h5 class="text-white">Total:</h5>
                            <h5 class="price-badge" style="font-size: 1.8rem;" id="final-total">{{ final_total|rupees }}</h5>
                        </div>
                    </div>
                </div>
                
                <!-- Draft notice -->
                {% if order and order.payment_status == 'pending' and not order.transaction_id %}
                <div class="alert alert-info mt-3">
                    <strong>Draft order created:</strong>
                    Order <code>{{ order.order_number }}</code> has been prepared. It will be finalized when you place the order.
                </div>
                {% endif %}

                <!-- Coupon Code Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-ticket-alt"></i> Have a Coupon Code?</h5>
                    </div>
                    <div class="card-body" id="coupon-input-body">
                        {% if applied_coupon %}
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>{{ applied_coupon.code }}</strong> applied!
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="remove-coupon-btn">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                        {% endif %}

                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="coupon-code-input" 
                                   placeholder="Enter coupon code" style="text-transform: uppercase;">
                            <button class="btn btn-primary" type="button" id="apply-coupon-btn">
                                <i class="fas fa-tag me-1"></i>Apply
                            </button>
                        </div>

                        {% if available_coupons %}
                        <datalist id="coupon-suggestions">
                            {% for coupon in available_coupons %}
                            <option value="{{ coupon.code }}">{{ coupon.discount_percentage }}% OFF{% if coupon.max_discount_amount %} (Max {{ coupon.max_discount_amount|rupees }}){% endif %}</option>
                            {% endfor %}
                        </datalist>

                        <div class="available-coupons">
                            <small class="text-muted mb-2 d-block"><i class="fas fa-info-circle me-1"></i>Available Coupons:</small>
                            <div class="row g-2">
                                {% for coupon in available_coupons %}
                                <div class="col-md-6">
                                    <div class="coupon-suggestion {% if applied_coupon and applied_coupon.code == coupon.code %}applied border-success{% endif %}" data-code="{{ coupon.code }}" data-discount-pct="{{ coupon.discount_percentage }}" data-max-discount="{% if coupon.max_discount_amount %}{{ coupon.max_discount_amount }}{% else %}0{% endif %}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong class="text-primary">{{ coupon.code }}</strong>
                                                <br>
                                                <small class="text-success">{{ coupon.discount_percentage }}% OFF</small>
                                                {% if coupon.max_discount_amount %}
                                                <br><small class="text-muted">Max: {{ coupon.max_discount_amount|rupees }}</small>
                                                {% endif %}
                                                {% if coupon.min_order_amount %}
                                                <br><small class="text-muted">Min: {{ coupon.min_order_amount|rupees }}</small>
                                                {% endif %}
                                            </div>
                                            {% if applied_coupon and applied_coupon.code == coupon.code %}
                                            <button type="button" class="btn btn-sm btn-success" disabled aria-disabled="true">
                                                <i class="fas fa-check-circle"></i> Applied
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-primary apply-suggested-coupon">
                                                Apply
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div id="coupon-message" class="mt-2"></div>
                    </div>
                </div>
                
                <form method="POST" class="checkout-form" id="ajax-checkout-form" autocomplete="off">
                    {% csrf_token %}
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card"></i> Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-method-selector">
                            <div class="payment-option">
                                <input type="radio" id="card" name="payment_method" value="card" required>
                                <label for="card" class="payment-card">
                                    <i class="fas fa-credit-card"></i>
                                    <span class="payment-name">Card Payment</span>
                                    <span class="payment-desc">Credit/Debit Card</span>
                                </label>
                            </div>
                            
                            <div class="payment-option">
                                <input type="radio" id="upi" name="payment_method" value="upi" required>
                                <label for="upi" class="payment-card">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span class="payment-name">UPI Payment</span>
                                    <span class="payment-desc">Google Pay, PhonePe, etc.</span>
                                </label>
                            </div>
                            
                            <div class="payment-option">
                                <input type="radio" id="netbanking" name="payment_method" value="netbanking" required>
                                <label for="netbanking" class="payment-card">
                                    <i class="fas fa-university"></i>
                                    <span class="payment-name">Net Banking</span>
                                    <span class="payment-desc">Online bank transfer</span>
                                </label>
                            </div>
                            
                            <div class="payment-option">
                                <input type="radio" id="wallet" name="payment_method" value="wallet" required>
                                <label for="wallet" class="payment-card">
                                    <i class="fas fa-wallet"></i>
                                    <span class="payment-name">Digital Wallet</span>
                                    <span class="payment-desc">Paytm, Amazon Pay, etc.</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-shipping-fast"></i> Shipping Information</h5>
                    </div>
                    <div class="card-body">
                        
                            <div class="mb-4">
                                <label class="form-label">Shipping Address *</label>
                                <textarea class="form-control" name="shipping_address" rows="3" required 
                                          placeholder="Enter your complete shipping address">{% if user.address %}{{ user.address }}{% endif %}</textarea>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Phone Number *</label>
                                <input type="text" class="form-control" name="phone_number" 
                                       value="{% if user.phone_number %}{{ user.phone_number }}{% endif %}" 
                                       required placeholder="Enter your phone number">
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="place-order-btn">
                                    <span id="place-order-btn-text"><i class="fas fa-check"></i> Place Order</span>
                                    <span id="place-order-btn-spinner" style="display:none"><i class="fas fa-spinner fa-spin"></i> Processing...</span>
                                </button>
                                <a href="{% url 'cart' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Cart
                                </a>
                            </div>
                            <div id="checkout-message" class="mt-3"></div>
                        
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug helpers: intercept navigation/reload to trace unexpected reloads
    try {
        (function(){
            const origReload = window.location.reload.bind(window.location);
            window.location.reload = function(){ console.debug('DEBUG: window.location.reload called'); console.trace(); return origReload(); };

            const origAssign = window.location.assign.bind(window.location);
            window.location.assign = function(url){ console.debug('DEBUG: window.location.assign called with', url); console.trace(); return origAssign(url); };

            const origReplace = window.location.replace.bind(window.location);
            window.location.replace = function(url){ console.debug('DEBUG: window.location.replace called with', url); console.trace(); return origReplace(url); };

            // Avoid attempting to redefine location.href (not configurable in many browsers)
        })();
    } catch(e) { console.debug('DEBUG: navigation intercept setup failed', e); }
    // Save the original coupon input area so we can restore it after AJAX removal
    const couponBody = document.getElementById('coupon-input-body');
    const originalCouponBodyHTML = couponBody ? couponBody.innerHTML : '';

    // Utility helpers
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function formatRupees(value) {
        try { return '₹' + Number(value).toFixed(2); } catch (e) { return value; }
    }
    function escapeHtml(unsafe) {
        return String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function computeEstimateFromCard(card) {
        if (!card) return null;
        const totalEl = document.getElementById('order-summary-body');
        const total = totalEl ? parseFloat(totalEl.dataset.total || '0') : 0;
        const pct = parseFloat(card.dataset.discountPct || card.dataset.discountPct === undefined ? (card.dataset.discountPct || card.getAttribute('data-discount-pct')) : card.dataset.discountPct);
        // fallback: try direct attribute access
        const pctAttr = card.getAttribute('data-discount-pct');
        const maxAttr = card.getAttribute('data-max-discount');
        const pctVal = (!isNaN(parseFloat(pctAttr))) ? parseFloat(pctAttr) : NaN;
        const maxVal = (!isNaN(parseFloat(maxAttr))) ? parseFloat(maxAttr) : 0;
        if (isNaN(pctVal)) return null;
        let discount = (total * pctVal) / 100;
        if (maxVal && maxVal > 0) discount = Math.min(discount, maxVal);
        const final_total = Math.max(0, total - discount);
        return { total, discount, final_total, pct: pctVal, max: maxVal };
    }
    function showMessage(message, type) {
        const msgDiv = document.getElementById('coupon-message');
        if (!msgDiv) return;
        msgDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => { msgDiv.innerHTML = ''; }, 5000);
    }

    // Apply coupon via AJAX and update summary in-place
    function applyCoupon(code) {
        console.debug('applyCoupon called with', code);
        const formData = new FormData();
        formData.append('coupon_code', code);

        // Disable suggestion apply buttons during request
        document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = true);

        fetch('{% url "apply_coupon" %}', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            console.debug('applyCoupon: fetch completed, status', response.status, 'url', response.url);
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                if (response.redirected || response.url.includes('{% url "login" %}')) {
                    console.debug('applyCoupon: detected redirect to login or HTML response');
                    showMessage('Please login to apply coupons.', 'danger');
                    setTimeout(() => { window.location.href = '{% url "login" %}?next={% url "checkout" %}'; }, 900);
                    throw new Error('auth');
                }
                return response.text().then(text => { throw { name: 'ParseError', text }; });
            }
            return response.json();
        })
        .then(data => {
            console.debug('applyCoupon: response data', data);
            if (!data.success) {
                showMessage(data.message, 'danger');
                document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = false);
                const applyBtn = document.getElementById('apply-coupon-btn'); if (applyBtn) applyBtn.disabled = false;
                return;
            }

            showMessage(data.message, 'success');

            // Update totals and discount UI if server provided values
            if (typeof data.final_total !== 'undefined') {
                const finalEl = document.getElementById('final-total');
                if (finalEl) finalEl.textContent = formatRupees(data.final_total);

                const discountEl = document.getElementById('discount-amount');
                if (discountEl) discountEl.textContent = formatRupees(data.discount || 0);

                const discountLabel = document.getElementById('discount-label');
                if (discountLabel && data.coupon_code) {
                    const pct = data.discount_percentage ? ` (${data.discount_percentage}%)` : '';
                    discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(data.coupon_code)}</strong>${pct}:`;
                }

                const youSavedEl = document.getElementById('you-saved');
                if (youSavedEl) {
                    youSavedEl.textContent = 'You saved ' + formatRupees(data.discount || 0);
                    youSavedEl.style.display = (data.discount && Number(data.discount) > 0) ? '' : 'none';
                }
            }

            // Replace coupon body with applied summary and wire remove handler
            const body = document.getElementById('coupon-input-body');
            if (body) {
                body.innerHTML = `
                    <div class="alert alert-success d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>${escapeHtml(data.coupon_code)}</strong> applied!
                            <br>
                            <small>You saved ${formatRupees(data.discount || 0)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="remove-coupon-btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                `;

                // Re-initialize handlers for new nodes
                initCouponUI();
            }

            // Update suggestion buttons appearance
            try {
                document.querySelectorAll('.apply-suggested-coupon').forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> Applied';
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-outline-primary');
                });
                if (data.coupon_code) {
                    const appliedCard = document.querySelector(`.coupon-suggestion[data-code="${data.coupon_code}"]`);
                    if (appliedCard) appliedCard.classList.add('border-success');
                }
            } catch (e) { console.warn('Suggestion update failed', e); }

            // If final_total is zero (guest saved), re-enable input controls so user can continue
            if (data.final_total === 0) {
                document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = false);
                const applyBtn = document.getElementById('apply-coupon-btn'); if (applyBtn) applyBtn.disabled = false;
            }
            // Refresh the page shortly after applying so server-rendered state is authoritative
            try { setTimeout(() => { window.location.reload(); }, 800); } catch(e){}
        })
        .catch(error => {
            console.error('Error applying coupon:', error);
            console.debug('applyCoupon: error object', error);
            showMessage('An error occurred. Please try again.', 'danger');
            document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = false);
            const applyBtn = document.getElementById('apply-coupon-btn'); if (applyBtn) applyBtn.disabled = false;
        });
    }

    // Preview coupon (server-side calc without persisting)
    function previewCoupon(code) {
        console.debug('previewCoupon called with', code);
        const formData = new FormData();
        formData.append('coupon_code', code);
        formData.append('preview', '1');

        return fetch('{% url "apply_coupon" %}', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            console.debug('previewCoupon: fetch completed, status', response.status, 'url', response.url);
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                if (response.redirected || response.url.includes('{% url "login" %}')) {
                    showMessage('Please login to preview coupons.', 'danger');
                    throw new Error('auth');
                }
                return response.text().then(text => { throw { name: 'ParseError', text }; });
            }
            return response.json();
        })
        .then(data => {
            console.debug('previewCoupon: response data', data);
            if (!data.success) {
                // show preview error but don't block apply
                showMessage(data.message, 'danger');
                return data;
            }

            // Update UI with authoritative server-side preview values
            if (typeof data.final_total !== 'undefined') {
                const finalEl = document.getElementById('final-total');
                if (finalEl) finalEl.textContent = formatRupees(data.final_total);

                const discountEl = document.getElementById('discount-amount');
                if (discountEl) discountEl.textContent = formatRupees(data.discount || 0);

                const discountLabel = document.getElementById('discount-label');
                if (discountLabel && data.coupon_code) {
                    const pct = data.discount_percentage ? ` (${data.discount_percentage}%)` : '';
                    discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(data.coupon_code)}</strong>${pct}:`;
                }

                const youSavedEl = document.getElementById('you-saved');
                if (youSavedEl) {
                    youSavedEl.textContent = 'You saved ' + formatRupees(data.discount || 0);
                    youSavedEl.style.display = (data.discount && Number(data.discount) > 0) ? '' : 'none';
                }
            }

            return data;
        })
        .catch(err => {
            console.error('previewCoupon error', err);
            return Promise.reject(err);
        });
    }

    // Initialize coupon UI event bindings. Call after DOM changes to re-wire.
    function initCouponUI() {
        const applyBtn = document.getElementById('apply-coupon-btn');
        const couponInput = document.getElementById('coupon-code-input');
        const removeBtn = document.getElementById('remove-coupon-btn');
        const couponsContainer = document.querySelector('.available-coupons');

        if (applyBtn && couponInput) {
            applyBtn.addEventListener('click', function() {
                const code = couponInput.value.trim().toUpperCase();
                if (!code) { showMessage('Please enter a coupon code', 'danger'); return; }
                // Immediate UI feedback: show applying placeholder in discount area
                const discountLabel = document.getElementById('discount-label');
                const discountEl = document.getElementById('discount-amount');
                const youSavedEl = document.getElementById('you-saved');
                // If this code matches a suggested coupon, show an immediate numeric estimate
                const suggestedCard = document.querySelector(`.coupon-suggestion[data-code="${code}"]`);
                if (suggestedCard) {
                    const est = computeEstimateFromCard(suggestedCard);
                    if (est) {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(estimate)</em>:`;
                        if (discountEl) discountEl.textContent = formatRupees(est.discount);
                        if (youSavedEl) { youSavedEl.textContent = 'You saved ' + formatRupees(est.discount); youSavedEl.style.display = ''; }
                    } else {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(applying&hellip;)</em>:`;
                        if (discountEl) discountEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
                        if (youSavedEl) { youSavedEl.textContent = 'Calculating...'; youSavedEl.style.display = ''; }
                    }
                } else {
                    if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(applying&hellip;)</em>:`;
                    if (discountEl) discountEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
                    if (youSavedEl) { youSavedEl.textContent = 'Calculating...'; youSavedEl.style.display = ''; }
                }

                applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Applying...';
                applyCoupon(code);
            });
            couponInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); applyBtn.click(); }
            });

            // Debounced preview when typing codes that match suggestions
            let previewTimer = null;
            couponInput.addEventListener('input', function(e) {
                clearTimeout(previewTimer);
                const code = (couponInput.value || '').trim().toUpperCase();
                if (!code) return;
                previewTimer = setTimeout(() => {
                    // Find matching suggestion (case-insensitive)
                    const matching = Array.from(document.querySelectorAll('.coupon-suggestion')).find(c => (c.getAttribute('data-code') || '').toUpperCase() === code);
                    if (matching) {
                        // Call preview to show server-accurate values but do not persist
                        previewCoupon(code).catch(err => console.warn('Preview on input failed', err));
                    }
                }, 450);
            });
        }

        if (couponsContainer) {
            couponsContainer.addEventListener('click', function(e) {
                const btn = e.target.closest('.apply-suggested-coupon');
                if (btn) {
                    e.preventDefault();
                    const card = btn.closest('.coupon-suggestion');
                    if (!card) return;
                    const code = card.dataset.code;
                    // Immediate UI feedback for suggestion click — compute numeric estimate
                    const discountLabel = document.getElementById('discount-label');
                    const discountEl = document.getElementById('discount-amount');
                    const youSavedEl = document.getElementById('you-saved');
                    const est = computeEstimateFromCard(card);
                    if (est) {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(estimate)</em>:`;
                        if (discountEl) discountEl.textContent = formatRupees(est.discount);
                        if (youSavedEl) { youSavedEl.textContent = 'You saved ' + formatRupees(est.discount); youSavedEl.style.display = ''; }
                    } else {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(applying&hellip;)</em>:`;
                        if (discountEl) discountEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
                        if (youSavedEl) { youSavedEl.textContent = 'Calculating...'; youSavedEl.style.display = ''; }
                    }
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    // Directly apply coupon on suggestion click (single request)
                    applyCoupon(code);
                    return;
                }
                const card = e.target.closest('.coupon-suggestion');
                if (card && !e.target.closest('button')) {
                    const code = card.dataset.code;
                    const inp = document.getElementById('coupon-code-input');
                    if (inp) { inp.value = code; inp.focus(); }
                }
            });
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                // Proceed immediately when user clicks Remove (no confirm dialog)
                console.debug('remove coupon: starting fetch');
                fetch('{% url "remove_coupon" %}', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.debug('remove coupon: fetch completed, status', response.status, 'url', response.url);
                    const ct = response.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) {
                        if (response.redirected || response.url.includes('{% url "login" %}')) {
                            // Don't use blocking alert(); show inline message and redirect
                            showMessage('Please login to remove coupons.', 'danger');
                            setTimeout(() => { window.location.href = '{% url "login" %}?next={% url "checkout" %}'; }, 900);
                            throw new Error('auth');
                        }
                        return response.text().then(text => { throw { name: 'ParseError', text }; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) { showMessage(data.message || 'Could not remove coupon', 'danger'); return; }

                    // Update totals and remove discount display
                    const finalEl = document.getElementById('final-total');
                    if (finalEl && typeof data.final_total !== 'undefined') finalEl.textContent = formatRupees(data.final_total);

                    const discountEl = document.getElementById('discount-amount'); if (discountEl) discountEl.textContent = '';
                    const discountLabel = document.getElementById('discount-label'); if (discountLabel) discountLabel.innerHTML = '';
                    const youSavedEl = document.getElementById('you-saved'); if (youSavedEl) youSavedEl.style.display = 'none';

                    // Restore original coupon input area and re-bind handlers
                    const body = document.getElementById('coupon-input-body');
                    if (body) {
                        body.innerHTML = originalCouponBodyHTML;
                        initCouponUI();
                    }
                    // Refresh page shortly after removing coupon to reflect server-side state
                    try { setTimeout(() => { window.location.reload(); }, 700); } catch(e){}
                })
                .catch(err => { if (err.message === 'auth') return; console.error('Remove error', err); showMessage('Could not remove coupon', 'danger'); });
            });
        }
    }

    // Initialize handlers on first load
    initCouponUI();
});
</script>
{% if order %}
<script>
// AJAX checkout form logic (provider-agnostic).
const checkoutForm = document.getElementById('ajax-checkout-form');
const placeOrderBtn = document.getElementById('place-order-btn');
const btnText = document.getElementById('place-order-btn-text');
const btnSpinner = document.getElementById('place-order-btn-spinner');
const messageDiv = document.getElementById('checkout-message');
function showCheckoutMessage(msg, type='danger') {
    messageDiv.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    setTimeout(() => { messageDiv.innerHTML = ''; }, 6000);
}
if (checkoutForm) {
    checkoutForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (placeOrderBtn) placeOrderBtn.disabled = true;
        if (btnText) btnText.style.display = 'none';
        if (btnSpinner) btnSpinner.style.display = '';
        showCheckoutMessage('');
        const formData = new FormData(checkoutForm);
        try {
            // Create the draft/final order via AJAX
            const resp = await fetch('/checkout/', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
                body: formData
            });
            const data = await resp.json();
            if (!resp.ok || !data.order_id) {
                throw new Error(data.error || 'Failed to create order');
            }

            // Ask backend to create provider order (Razorpay-backed endpoint)
            // Build URL from the named route to avoid hardcoding and to support prefixing
            const createUrlTemplate = "{% url 'create_razorpay_payment' 0 %}"; // will contain /0/ which we replace
            const createUrl = createUrlTemplate.replace('/0/', `/${data.order_id}/`);
            const provResp = await fetch(createUrl, { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken'), 'X-Requested-With': 'XMLHttpRequest' } });
            if (!provResp.ok) {
                let errText = 'Failed to create payment order';
                try { const errJson = await provResp.json(); if (errJson && errJson.error) errText = errJson.error; } catch(e){}
                throw new Error(errText);
            }
            const provJson = await provResp.json();

            // Expected response: { razorpay_order_id, razorpay_key_id, amount, currency }
            const rOrderId = provJson.razorpay_order_id;
            const rKeyId = provJson.razorpay_key_id || provJson.key_id || provJson.razorpay_key;
            if (!rOrderId || !rKeyId) {
                throw new Error('Provider did not return required Razorpay parameters');
            }

            // Load Razorpay checkout script if needed
            function loadScript(src){
                return new Promise((resolve, reject) => {
                    if (window.Razorpay) return resolve();
                    const s = document.createElement('script');
                    s.src = src;
                    s.onload = () => resolve();
                    s.onerror = () => reject(new Error('Failed to load Razorpay script'));
                    document.head.appendChild(s);
                });
            }

            try {
                await loadScript('https://checkout.razorpay.com/v1/checkout.js');
            } catch (err) {
                console.error('Razorpay script load failed', err);
                throw new Error('Could not load Razorpay checkout library');
            }

            const options = {
                key: rKeyId,
                amount: provJson.amount || provJson.amount_paise || undefined,
                currency: provJson.currency || 'INR',
                name: "{{ SITE_NAME|escapejs }}",
                description: `Order ${data.order_id}`,
                order_id: rOrderId,
                handler: async function(response){
                    // response contains: razorpay_payment_id, razorpay_order_id, razorpay_signature
                    try {
                        const verifyPayload = {
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            order_id: data.order_id
                        };
                        const verifyResp = await fetch('{% url "verify_razorpay_payment" %}', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify(verifyPayload)
                        });
                        if (!verifyResp.ok) throw new Error('Verification failed');
                        const vjson = await verifyResp.json();
                        if (vjson.success) {
                            // Redirect to confirmation
                            window.location.href = `/order-confirmation/${data.order_id}/`;
                        } else {
                            throw new Error(vjson.message || 'Payment verification failed');
                        }
                    } catch (err) {
                        showCheckoutMessage(err.message || 'Payment verification failed.');
                        if (placeOrderBtn) placeOrderBtn.disabled = false;
                        if (btnText) btnText.style.display = '';
                        if (btnSpinner) btnSpinner.style.display = 'none';
                    }
                },
                prefill: {
                    email: "{{ user.email|default:''|escapejs }}",
                    contact: document.querySelector('input[name="phone_number"]') ? document.querySelector('input[name="phone_number"]').value : "{{ user.phone_number|default:''|escapejs }}"
                },
                modal: {
                    ondismiss: function(){
                        // User dismissed the checkout popup
                        showCheckoutMessage('Payment cancelled');
                        if (placeOrderBtn) placeOrderBtn.disabled = false;
                        if (btnText) btnText.style.display = '';
                        if (btnSpinner) btnSpinner.style.display = 'none';
                    }
                }
            };

            const rzp = new window.Razorpay(options);
            rzp.open();
                } catch (err) {
                    showCheckoutMessage(err.message || 'Order failed. Please try again.');
                    if (placeOrderBtn) placeOrderBtn.disabled = false;
                    if (btnText) btnText.style.display = '';
                    if (btnSpinner) btnSpinner.style.display = 'none';
                }
            });
        }
        {% endif %}
        </script>
        {% endblock %}
