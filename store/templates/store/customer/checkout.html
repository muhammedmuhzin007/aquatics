{% extends 'store/base.html' %}
{% load currency %}

{% block extra_css %}
<style>
    /* Center the checkout page content */
    .checkout-center .container-fluid {
        max-width: 1000px;
        margin: 0 auto;
    }

    /* Payment Method Selection Styles */
    .payment-method-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .payment-option { position: relative; }
    .payment-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
    }
    .payment-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        min-height: 140px;
        justify-content: center;
    }
    /* Light theme base for payment tiles */
    html[data-theme='light'] .payment-card { background: var(--light-card); border-color: var(--light-border); }
    /* Hover state adapts to theme */
    html[data-theme='dark'] .payment-card:hover { background: rgba(255,255,255,0.05); border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(30,136,229,0.15); }
    html[data-theme='light'] .payment-card:hover { background: rgba(30,136,229,0.06); border-color: var(--accent-blue); box-shadow: 0 4px 12px rgba(30,136,229,0.10); }

    .payment-option input[type="radio"]:checked + .payment-card {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(30,136,229,0.2);
        background: linear-gradient(135deg, rgba(30,136,229,0.12), transparent);
    }
    .payment-card i { font-size: 2.5rem; color: var(--accent-blue); }
    .payment-card .payment-name { font-weight: 600; font-size: 1rem; text-align: center; color: var(--text-white); }
    .payment-card .payment-desc { font-size: 0.75rem; text-align: center; color: rgba(255,255,255,0.7); }
    html[data-theme='light'] .payment-card .payment-name { color: var(--light-text); }
    html[data-theme='light'] .payment-card .payment-desc { color: var(--light-text-soft, rgba(0,0,0,0.6)); }
    .payment-option input[type="radio"]:checked + .payment-card i { color: var(--accent-blue); animation: pulse 0.5s ease; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

    /* Themed form controls */
    .checkout-form .form-control,
    .checkout-form textarea.form-control {
        background: var(--card-bg) !important; /* dark default */
        border: 1px solid var(--border-color) !important;
        color: var(--text-white) !important;
        border-radius: 8px;
    }
    /* Light theme inputs should be bright surface with light borders/text */
    html[data-theme='light'] .checkout-form .form-control,
    html[data-theme='light'] .checkout-form textarea.form-control {
        background: var(--light-surface) !important;
        border-color: var(--light-border) !important;
        color: var(--light-text) !important;
    }
    .checkout-form .form-control::placeholder,
    .checkout-form textarea.form-control::placeholder { color: rgba(255,255,255,0.6) !important; }
    html[data-theme='light'] .checkout-form .form-control::placeholder,
    html[data-theme='light'] .checkout-form textarea.form-control::placeholder { color: var(--light-text-soft, rgba(0,0,0,0.5)) !important; }
    .checkout-form .form-control:focus,
    .checkout-form textarea.form-control:focus {
        background: var(--card-bg) !important;
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(30,136,229,0.15) !important;
    }
    .checkout-form .form-label { color: var(--text-white) !important; font-weight: 500; }
    html[data-theme='light'] .checkout-form .form-label { color: var(--light-text) !important; }

    /* Card header titles adapt to theme on checkout */
    html[data-theme='dark'] .checkout-center .card-header h5 { color: var(--text-white) !important; }
    html[data-theme='light'] .checkout-center .card-header h5 { color: var(--light-text) !important; }
    
    /* Coupon suggestion styles */
    .available-coupons {
        margin-top: 1rem;
    }
    
    .coupon-suggestion {
        background: rgba(102, 126, 234, 0.1);
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    /* Make coupon cards even height and align contents */
    .available-coupons .row > [class*="col-"] {
        display: flex; /* ensure columns stretch to same height */
    }
    .available-coupons .coupon-suggestion {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        min-height: 110px; /* consistent card height */
        box-sizing: border-box;
        padding: 1rem;
    }
    .available-coupons .coupon-suggestion > .d-flex {
        flex: 1 1 auto; /* let inner content take remaining space */
        align-items: center;
    }
    .available-coupons .coupon-suggestion .text-primary { font-size: 1.05rem; }
    
    html[data-theme='light'] .coupon-suggestion {
        background: rgba(102, 126, 234, 0.05);
        border-color: var(--light-border);
    }
    
    .coupon-suggestion:hover {
        background: rgba(102, 126, 234, 0.15);
        border-color: var(--accent-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    html[data-theme='light'] .coupon-suggestion:hover {
        background: rgba(102, 126, 234, 0.1);
    }

    .upi-qr-inline {
        display: none;
        border: 1px dashed var(--accent-blue);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        background: rgba(30,136,229,0.08);
    }
    html[data-theme='light'] .upi-qr-inline {
        background: rgba(30,136,229,0.06);
    }
    .upi-qr-inline h6 {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-white);
    }
    html[data-theme='light'] .upi-qr-inline h6 {
        color: var(--light-text);
    }
    .upi-qr-body {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }
    .upi-qr-body img {
        width: 150px;
        height: 150px;
        border-radius: 8px;
        background: #fff;
        padding: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .upi-qr-meta {
        flex: 1 1 200px;
        min-width: 200px;
    }
    .upi-qr-id {
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        word-break: break-all;
        color: var(--text-white);
    }
    html[data-theme='light'] .upi-qr-id {
        color: var(--light-text);
    }
    .upi-qr-links a {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        margin-right: 0.5rem;
        margin-top: 0.5rem;
    }
    .upi-qr-note {
        margin-top: 0.75rem;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.8);
    }
    html[data-theme='light'] .upi-qr-note {
        color: rgba(0,0,0,0.6);
    }
</style>
{% endblock %}

{% block content %}
<section class="section checkout-center">
    <div class="container-fluid">
        <h2 class="section-heading text-center">Checkout</h2>

        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8 col-xl-7 mb-4">
                <form method="POST" class="checkout-form" id="ajax-checkout-form" autocomplete="off">
                    {% csrf_token %}

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-shipping-fast"></i> Shipping Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label class="form-label">Shipping Address *</label>
                                <textarea class="form-control" name="shipping_address" rows="3" required 
                                          placeholder="Enter your complete shipping address">{{ shipping_address_prefill }}</textarea>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">State *</label>
                                <input type="text" class="form-control" name="shipping_state" value="{{ shipping_state_prefill }}" required placeholder="State / Region">
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Pincode *</label>
                                <input type="text" class="form-control" name="shipping_pincode" value="{{ shipping_pincode_prefill }}" required placeholder="Postal code">
                            </div>
                            <div class="mb-0">
                                <label class="form-label">Phone Number *</label>
                                <input type="text" class="form-control" name="phone_number" 
                                       value="{% if user.phone_number %}{{ user.phone_number }}{% endif %}" 
                                       required placeholder="Enter your phone number">
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="text-white"><i class="fas fa-shopping-cart"></i> Order Summary</h5>
                        </div>
                        <div class="card-body" id="order-summary-body" data-total="{{ total }}" data-discount="{{ discount }}" data-weight="{{ total_weight }}" data-kerala-rate="{{ kerala_delivery_rate|floatformat:2 }}" data-default-rate="{{ default_delivery_rate|floatformat:2 }}">
                            {% for item in cart_items %}
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <strong class="text-white">{{ item.fish.name }}</strong><br>
                                    <small class="text-gray">{{ item.fish.breed.name }} x {{ item.quantity }}</small>
                                </div>
                                <strong class="text-white">{{ item.get_total|rupees }}</strong>
                            </div>
                            {% endfor %}
                            {% for plant in plant_items %}
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <strong class="text-white">{{ plant.plant.name }}</strong><br>
                                    <small class="text-gray">Plant x {{ plant.quantity }}</small>
                                </div>
                                <strong class="text-white">{{ plant.get_total|rupees }}</strong>
                            </div>
                            {% endfor %}
                            {% for accessory in accessory_items %}
                            <div class="d-flex justify-content-between mb-3 pb-3" style="border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <strong class="text-white">{{ accessory.accessory.name }}</strong><br>
                                    <small class="text-gray">Accessory x {{ accessory.quantity }}</small>
                                </div>
                                <strong class="text-white">{{ accessory.get_total|rupees }}</strong>
                            </div>
                            {% endfor %}
                            <div class="d-flex justify-content-between mt-3 pt-3" style="border-top: 2px solid var(--border-color);">
                                <h6 class="text-white">Subtotal:</h6>
                                <h6 class="text-white">{{ total|rupees }}</h6>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-white">Total Weight:</span>
                                <span class="text-white" id="total-weight-display" data-weight="{{ total_weight }}">{{ total_weight|floatformat:3 }} kg</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-white">Delivery Charge (<span id="delivery-rate-text" data-rate="{{ delivery_rate }}">₹{{ delivery_rate|floatformat:0 }}</span>/kg)</span>
                                <span class="text-white" id="delivery-charge-display" data-amount="{{ delivery_charge }}">{{ delivery_charge|rupees }}</span>
                            </div>
                            <div class="d-flex justify-content-between text-success" id="discount-row" {% if discount|floatformat:2 == '0.00' %}style="display:none;"{% endif %}>
                                <span id="discount-label">
                                    {% if applied_coupon %}
                                    <i class="fas fa-tag me-1"></i>Coupon <strong>{{ applied_coupon.code }}</strong> ({{ applied_coupon.discount_percentage }}%):
                                    {% endif %}
                                </span>
                                <span id="discount-amount" data-discount="{{ discount }}">{{ discount|rupees }}</span>
                            </div>
                            <div class="text-success mt-1" id="you-saved" {% if discount|floatformat:2 == '0.00' %}style="display:none;"{% endif %}>
                                You saved {{ discount|rupees }}
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <h5 class="text-white">Total:</h5>
                                <h5 class="price-badge" style="font-size: 1.8rem;" id="final-total" data-final="{{ final_total }}">{{ final_total|rupees }}</h5>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Draft notice -->
                    {% if order and order.payment_status == 'pending' and not order.transaction_id %}
                    <div class="alert alert-info mt-3">
                        <strong>Draft order created:</strong>
                        Order <code>{{ order.order_number }}</code> has been prepared. It will be finalized when you place the order.
                    </div>
                    {% endif %}

                    <!-- Coupon Code Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-ticket-alt"></i> Have a Coupon Code?</h5>
                        </div>
                        <div class="card-body" id="coupon-input-body">
                        {% if applied_coupon %}
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>{{ applied_coupon.code }}</strong> applied!
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="remove-coupon-btn">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                        {% endif %}

                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="coupon-code-input" 
                                   placeholder="Enter coupon code" style="text-transform: uppercase;">
                            <button class="btn btn-primary" type="button" id="apply-coupon-btn">
                                <i class="fas fa-tag me-1"></i>Apply
                            </button>
                        </div>

                        {% if available_coupons %}
                        <datalist id="coupon-suggestions">
                            {% for coupon in available_coupons %}
                            <option value="{{ coupon.code }}">{{ coupon.discount_percentage }}% OFF{% if coupon.max_discount_amount %} (Max {{ coupon.max_discount_amount|rupees }}){% endif %}</option>
                            {% endfor %}
                        </datalist>

                        <div class="available-coupons">
                            <small class="text-muted mb-2 d-block"><i class="fas fa-info-circle me-1"></i>Available Coupons:</small>
                            <div class="row g-2">
                                {% for coupon in available_coupons %}
                                <div class="col-md-6">
                                    <div class="coupon-suggestion {% if applied_coupon and applied_coupon.code == coupon.code %}applied border-success{% endif %}" data-code="{{ coupon.code }}" data-discount-pct="{{ coupon.discount_percentage }}" data-max-discount="{% if coupon.max_discount_amount %}{{ coupon.max_discount_amount }}{% else %}0{% endif %}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong class="text-primary">{{ coupon.code }}</strong>
                                                <br>
                                                <small class="text-success">{{ coupon.discount_percentage }}% OFF</small>
                                                {% if coupon.max_discount_amount %}
                                                <br><small class="text-muted">Max: {{ coupon.max_discount_amount|rupees }}</small>
                                                {% endif %}
                                                {% if coupon.min_order_amount %}
                                                <br><small class="text-muted">Min: {{ coupon.min_order_amount|rupees }}</small>
                                                {% endif %}
                                            </div>
                                            {% if applied_coupon and applied_coupon.code == coupon.code %}
                                            <button type="button" class="btn btn-sm btn-success" disabled aria-disabled="true">
                                                <i class="fas fa-check-circle"></i> Applied
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-primary apply-suggested-coupon">
                                                Apply
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div id="coupon-message" class="mt-2"></div>
                    </div>
                </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-credit-card"></i> Payment Method</h5>
                        </div>
                        <div class="card-body">
                            <div class="payment-method-selector">
                                <div class="payment-option">
                                    <input type="radio" id="card" name="payment_method" value="card" required>
                                    <label for="card" class="payment-card">
                                        <i class="fas fa-credit-card"></i>
                                        <span class="payment-name">Card Payment</span>
                                        <span class="payment-desc">Credit/Debit Card</span>
                                    </label>
                                </div>

                                <div class="payment-option">
                                    <input type="radio" id="upi" name="payment_method" value="upi" required>
                                    <label for="upi" class="payment-card">
                                        <i class="fas fa-mobile-alt"></i>
                                        <span class="payment-name">UPI Payment</span>
                                        <span class="payment-desc">Google Pay, PhonePe, etc.</span>
                                    </label>
                                </div>

                                <div class="payment-option">
                                    <input type="radio" id="netbanking" name="payment_method" value="netbanking" required>
                                    <label for="netbanking" class="payment-card">
                                        <i class="fas fa-university"></i>
                                        <span class="payment-name">Net Banking</span>
                                        <span class="payment-desc">Online bank transfer</span>
                                    </label>
                                </div>

                                <div class="payment-option">
                                    <input type="radio" id="wallet" name="payment_method" value="wallet" required>
                                    <label for="wallet" class="payment-card">
                                        <i class="fas fa-wallet"></i>
                                        <span class="payment-name">Digital Wallet</span>
                                        <span class="payment-desc">Paytm, Amazon Pay, etc.</span>
                                    </label>
                                </div>
                            </div>
                            <div class="upi-qr-inline" id="upi-qr-section">
                                <h6><i class="fas fa-qrcode me-2"></i>UPI QR (Backup)</h6>
                                <div class="upi-qr-body">
                                    <img id="upi-qr-image" alt="UPI QR Code" src="" loading="lazy" />
                                    <div class="upi-qr-meta">
                                        <div class="small text-muted">Pay to UPI ID</div>
                                        <div class="upi-qr-id" id="upi-qr-upi-id"></div>
                                        <div class="upi-qr-links mt-2">
                                            <a href="#" id="upi-phonepe-link" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fas fa-mobile-alt"></i> PhonePe</a>
                                            <a href="#" id="upi-gpay-link" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fab fa-google"></i> Google Pay</a>
                                            <a href="#" id="upi-paytm-link" class="btn btn-sm btn-outline-primary" target="_blank"><i class="fas fa-wallet"></i> Paytm</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="upi-qr-note">
                                    Razorpay will open next for secure payment confirmation. Use this QR only if the popup does not display your UPI options.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="place-order-btn">
                            <span id="place-order-btn-text"><i class="fas fa-check"></i> Place Order</span>
                            <span id="place-order-btn-spinner" style="display:none"><i class="fas fa-spinner fa-spin"></i> Processing...</span>
                        </button>
                        <a href="{% url 'cart' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Cart
                        </a>
                    </div>
                    <div id="checkout-message" class="mt-3"></div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug helpers: intercept navigation/reload to trace unexpected reloads
    try {
        (function(){
            const origReload = window.location.reload.bind(window.location);
            window.location.reload = function(){ console.debug('DEBUG: window.location.reload called'); console.trace(); return origReload(); };

            const origAssign = window.location.assign.bind(window.location);
            window.location.assign = function(url){ console.debug('DEBUG: window.location.assign called with', url); console.trace(); return origAssign(url); };

            const origReplace = window.location.replace.bind(window.location);
            window.location.replace = function(url){ console.debug('DEBUG: window.location.replace called with', url); console.trace(); return origReplace(url); };

            // Avoid attempting to redefine location.href (not configurable in many browsers)
        })();
    } catch(e) { console.debug('DEBUG: navigation intercept setup failed', e); }
    // Save the original coupon input area so we can restore it after AJAX removal
    const couponBody = document.getElementById('coupon-input-body');
    const originalCouponBodyHTML = couponBody ? couponBody.innerHTML : '';

    // Utility helpers
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    const orderSummary = document.getElementById('order-summary-body');
    const totalWeightDisplay = document.getElementById('total-weight-display');
    const deliveryRateText = document.getElementById('delivery-rate-text');
    const deliveryChargeDisplay = document.getElementById('delivery-charge-display');
    const finalTotalEl = document.getElementById('final-total');
    const discountRow = document.getElementById('discount-row');
    const discountAmountEl = document.getElementById('discount-amount');
    const youSavedBanner = document.getElementById('you-saved');
    const shippingAddressInput = document.querySelector('textarea[name="shipping_address"]');
    const shippingStateInput = document.querySelector('input[name="shipping_state"]');
    const shippingPincodeInput = document.querySelector('input[name="shipping_pincode"]');

    function coalesce(value, fallback) {
        return value === undefined || value === null ? fallback : value;
    }

    function extractNumeric(value) {
        if (value === undefined || value === null) return null;
        const cleaned = String(value).replace(/[^\d.-]/g, '');
        if (!cleaned) return null;
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : null;
    }

    function safeNumber(value, fallback) {
        const numeric = extractNumeric(value);
        if (numeric !== null) return numeric;
        if (typeof value === 'number' && Number.isFinite(value)) return value;
        return fallback;
    }

    function formatRupees(value) {
        return '₹' + safeNumber(value, 0).toFixed(2);
    }

    const totalsState = window.__checkoutTotals || {};
    const subtotalValue = extractNumeric(orderSummary ? orderSummary.dataset.total : null);
    const discountDataValue = extractNumeric(orderSummary ? orderSummary.dataset.discount : null);
    const discountSpanValue = extractNumeric(discountAmountEl ? discountAmountEl.dataset.discount : null);
    const weightValue = extractNumeric(orderSummary ? orderSummary.dataset.weight : null);
    const rateValue = extractNumeric(deliveryRateText ? deliveryRateText.dataset.rate : null);
    const keralaRateAttr = extractNumeric(orderSummary ? orderSummary.dataset.keralaRate : null);
    const defaultRateAttr = extractNumeric(orderSummary ? orderSummary.dataset.defaultRate : null);
    const baseKeralaRate = keralaRateAttr !== null ? keralaRateAttr : 60;
    const baseDefaultRate = defaultRateAttr !== null ? defaultRateAttr : 100;
    const chargeValue = extractNumeric(deliveryChargeDisplay ? deliveryChargeDisplay.dataset.amount : null);

    totalsState.subtotal = coalesce(totalsState.subtotal, subtotalValue !== null ? subtotalValue : 0);
    totalsState.discount = coalesce(totalsState.discount, discountSpanValue !== null ? discountSpanValue : (discountDataValue !== null ? discountDataValue : 0));
    totalsState.weight = coalesce(totalsState.weight, weightValue !== null ? weightValue : 0);
    totalsState.keralaRate = coalesce(totalsState.keralaRate, baseKeralaRate);
    totalsState.defaultRate = coalesce(totalsState.defaultRate, baseDefaultRate);
    totalsState.deliveryRate = coalesce(totalsState.deliveryRate, rateValue !== null ? rateValue : baseDefaultRate);
    const derivedCharge = safeNumber((totalsState.weight || 0) * totalsState.deliveryRate, 0);
    totalsState.deliveryCharge = coalesce(totalsState.deliveryCharge, chargeValue !== null ? chargeValue : derivedCharge);
    totalsState.deliveryCharge = Number(safeNumber(totalsState.deliveryCharge, 0).toFixed(2));
    totalsState.final = Math.max(0, totalsState.subtotal - totalsState.discount) + totalsState.deliveryCharge;
    window.__checkoutTotals = totalsState;

    function determineDeliveryRate(state, pincode, address) {
        const keralaRate = safeNumber(totalsState.keralaRate, baseKeralaRate);
        const defaultRate = safeNumber(totalsState.defaultRate, baseDefaultRate);
        const stateValue = (state || '').toString().trim().toLowerCase();
        if (stateValue === 'kerala') return keralaRate;
        const digits = (pincode || '').toString().replace(/\D/g, '');
        if (digits.length >= 2 && (digits.startsWith('67') || digits.startsWith('68') || digits.startsWith('69'))) return keralaRate;
        const addressValue = (address || '').toString().toLowerCase();
        if (addressValue.includes('kerala')) return keralaRate;
        return defaultRate;
    }

    function updateTotalsDisplay() {
        if (orderSummary) {
            orderSummary.dataset.total = totalsState.subtotal.toFixed(2);
            orderSummary.dataset.discount = totalsState.discount.toFixed(2);
            orderSummary.dataset.weight = totalsState.weight.toFixed(3);
            orderSummary.dataset.keralaRate = safeNumber(totalsState.keralaRate, baseKeralaRate).toFixed(2);
            orderSummary.dataset.defaultRate = safeNumber(totalsState.defaultRate, baseDefaultRate).toFixed(2);
        }
        if (totalWeightDisplay) {
            totalWeightDisplay.dataset.weight = totalsState.weight.toFixed(3);
            totalWeightDisplay.textContent = totalsState.weight.toFixed(3) + ' kg';
        }
        if (deliveryRateText) {
            deliveryRateText.dataset.rate = totalsState.deliveryRate.toFixed(2);
            deliveryRateText.textContent = '₹' + safeNumber(totalsState.deliveryRate, 0).toFixed(0);
        }
        if (deliveryChargeDisplay) {
            deliveryChargeDisplay.dataset.amount = totalsState.deliveryCharge.toFixed(2);
            deliveryChargeDisplay.textContent = formatRupees(totalsState.deliveryCharge);
        }
        if (discountRow) {
            discountRow.style.display = totalsState.discount > 0 ? 'flex' : 'none';
        }
        if (discountAmountEl) {
            discountAmountEl.dataset.discount = totalsState.discount.toFixed(2);
            discountAmountEl.textContent = totalsState.discount > 0 ? formatRupees(totalsState.discount) : formatRupees(0);
        }
        const finalCalculated = Math.max(0, totalsState.subtotal - totalsState.discount) + totalsState.deliveryCharge;
        totalsState.final = Number(finalCalculated.toFixed(2));
        if (finalTotalEl) {
            finalTotalEl.dataset.final = totalsState.final.toFixed(2);
            finalTotalEl.textContent = formatRupees(totalsState.final);
        }
        if (youSavedBanner) {
            if (totalsState.discount > 0) {
                youSavedBanner.textContent = 'You saved ' + formatRupees(totalsState.discount);
                youSavedBanner.style.display = '';
            } else {
                youSavedBanner.style.display = 'none';
            }
        }
    }

    function recalcTotalsFromShipping() {
        const rate = determineDeliveryRate(
            shippingStateInput ? shippingStateInput.value : '',
            shippingPincodeInput ? shippingPincodeInput.value : '',
            shippingAddressInput ? shippingAddressInput.value : ''
        );
        totalsState.deliveryRate = rate;
        const charge = safeNumber((totalsState.weight || 0) * rate, totalsState.deliveryCharge);
        totalsState.deliveryCharge = Number(charge.toFixed(2));
        updateTotalsDisplay();
    }

    function appendShipping(formData) {
        if (!formData) return;
        if (shippingAddressInput) formData.append('shipping_address', shippingAddressInput.value || '');
        if (shippingStateInput) formData.append('shipping_state', shippingStateInput.value || '');
        if (shippingPincodeInput) formData.append('shipping_pincode', shippingPincodeInput.value || '');
    }

    function updateTotalsFromResponse(data) {
        if (!data) return;
        if (typeof data.total !== 'undefined') {
            totalsState.subtotal = safeNumber(data.total, totalsState.subtotal);
        }
        if (typeof data.discount !== 'undefined') {
            totalsState.discount = safeNumber(data.discount, totalsState.discount);
        }
        if (typeof data.total_weight !== 'undefined') {
            totalsState.weight = safeNumber(data.total_weight, totalsState.weight);
        }
        if (typeof data.delivery_rate !== 'undefined') {
            totalsState.deliveryRate = safeNumber(data.delivery_rate, totalsState.deliveryRate);
        }
        if (typeof data.delivery_charge !== 'undefined') {
            totalsState.deliveryCharge = Number(safeNumber(data.delivery_charge, totalsState.deliveryCharge).toFixed(2));
        } else {
            const fallbackCharge = safeNumber((totalsState.weight || 0) * totalsState.deliveryRate, totalsState.deliveryCharge);
            totalsState.deliveryCharge = Number(fallbackCharge.toFixed(2));
        }
        if (typeof data.kerala_delivery_rate !== 'undefined') {
            totalsState.keralaRate = safeNumber(data.kerala_delivery_rate, totalsState.keralaRate);
        }
        if (typeof data.default_delivery_rate !== 'undefined') {
            totalsState.defaultRate = safeNumber(data.default_delivery_rate, totalsState.defaultRate);
        }
        updateTotalsDisplay();
    }

    window.__checkoutTotals = totalsState;
    window.__checkoutDetermineRate = determineDeliveryRate;
    window.__checkoutUpdateSummary = updateTotalsDisplay;
    window.__checkoutRecalculateShipping = recalcTotalsFromShipping;

    let shippingDebounce = null;
    [shippingAddressInput, shippingStateInput, shippingPincodeInput].forEach(function(input) {
        if (!input) return;
        input.addEventListener('input', function() {
            clearTimeout(shippingDebounce);
            shippingDebounce = setTimeout(recalcTotalsFromShipping, 180);
        });
        input.addEventListener('change', recalcTotalsFromShipping);
    });

    updateTotalsDisplay();
    recalcTotalsFromShipping();

    function escapeHtml(unsafe) {
        return String(unsafe).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function computeEstimateFromCard(card) {
        if (!card) return null;
        const pctAttr = card.getAttribute('data-discount-pct');
        const maxAttr = card.getAttribute('data-max-discount');
        const pctVal = Number(pctAttr);
        if (!Number.isFinite(pctVal)) return null;
        const maxVal = Number.isFinite(Number(maxAttr)) ? Number(maxAttr) : 0;
        let discount = (totalsState.subtotal * pctVal) / 100;
        if (maxVal > 0) discount = Math.min(discount, maxVal);
        const finalTotal = Math.max(0, totalsState.subtotal - discount) + totalsState.deliveryCharge;
        return { total: totalsState.subtotal, discount, final_total: finalTotal, pct: pctVal, max: maxVal };
    }
    function showMessage(message, type) {
        const msgDiv = document.getElementById('coupon-message');
        if (!msgDiv) return;
        msgDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => { msgDiv.innerHTML = ''; }, 5000);
    }

    // Apply coupon via AJAX and update summary in-place
    function applyCoupon(code) {
        console.debug('applyCoupon called with', code);
        const formData = new FormData();
        formData.append('coupon_code', code);
        appendShipping(formData);

        // Disable suggestion apply buttons during request
        document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = true);

        fetch('{% url "apply_coupon" %}', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            console.debug('applyCoupon: fetch completed, status', response.status, 'url', response.url);
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                if (response.redirected || response.url.includes('{% url "login" %}')) {
                    console.debug('applyCoupon: detected redirect to login or HTML response');
                    showMessage('Please login to apply coupons.', 'danger');
                    setTimeout(() => { window.location.href = '{% url "login" %}?next={% url "checkout" %}'; }, 900);
                    throw new Error('auth');
                }
                return response.text().then(text => { throw { name: 'ParseError', text }; });
            }
            return response.json();
        })
        .then(data => {
            console.debug('applyCoupon: response data', data);
            if (!data.success) {
                showMessage(data.message, 'danger');
                document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = false);
                const applyBtn = document.getElementById('apply-coupon-btn'); if (applyBtn) applyBtn.disabled = false;
                return;
            }

            updateTotalsFromResponse(data);
            showMessage(data.message, 'success');

            const finalEl = document.getElementById('final-total');
            if (finalEl) finalEl.textContent = formatRupees(totalsState.final);

            const discountEl = document.getElementById('discount-amount');
            if (discountEl) discountEl.textContent = formatRupees(totalsState.discount);

            const discountLabel = document.getElementById('discount-label');
            if (discountLabel && data.coupon_code) {
                const pct = data.discount_percentage ? ` (${data.discount_percentage}%)` : '';
                discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(data.coupon_code)}</strong>${pct}:`;
            }

            const youSavedEl = document.getElementById('you-saved');
            if (youSavedEl) {
                youSavedEl.textContent = 'You saved ' + formatRupees(totalsState.discount);
                youSavedEl.style.display = totalsState.discount > 0 ? '' : 'none';
            }

            // Replace coupon body with applied summary and wire remove handler
            const body = document.getElementById('coupon-input-body');
            if (body) {
                body.innerHTML = `
                    <div class="alert alert-success d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>${escapeHtml(data.coupon_code)}</strong> applied!
                            <br>
                            <small>You saved ${formatRupees(totalsState.discount)}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="remove-coupon-btn">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                `;

                // Re-initialize handlers for new nodes
                initCouponUI();
            }

            // Update suggestion buttons appearance
            try {
                document.querySelectorAll('.apply-suggested-coupon').forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> Applied';
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-outline-primary');
                });
                if (data.coupon_code) {
                    const appliedCard = document.querySelector(`.coupon-suggestion[data-code="${data.coupon_code}"]`);
                    if (appliedCard) appliedCard.classList.add('border-success');
                }
            } catch (e) { console.warn('Suggestion update failed', e); }

            // If final_total is zero (guest saved), re-enable input controls so user can continue
            if (data.final_total === 0) {
                document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = false);
                const applyBtn = document.getElementById('apply-coupon-btn'); if (applyBtn) applyBtn.disabled = false;
            }
            if (data.force_refresh) {
                try { setTimeout(() => { window.location.reload(); }, 800); } catch(e){}
            }
        })
        .catch(error => {
            if (error && error.message === 'auth') return;
            console.error('Error applying coupon:', error);
            console.debug('applyCoupon: error object', error);
            showMessage('An error occurred. Please try again.', 'danger');
            document.querySelectorAll('.apply-suggested-coupon').forEach(btn => btn.disabled = false);
            const applyBtn = document.getElementById('apply-coupon-btn'); if (applyBtn) applyBtn.disabled = false;
        });
    }

    // Preview coupon (server-side calc without persisting)
    function previewCoupon(code) {
        console.debug('previewCoupon called with', code);
        const formData = new FormData();
        formData.append('coupon_code', code);
        formData.append('preview', '1');
        appendShipping(formData);

        return fetch('{% url "apply_coupon" %}', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            console.debug('previewCoupon: fetch completed, status', response.status, 'url', response.url);
            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                if (response.redirected || response.url.includes('{% url "login" %}')) {
                    showMessage('Please login to preview coupons.', 'danger');
                    throw new Error('auth');
                }
                return response.text().then(text => { throw { name: 'ParseError', text }; });
            }
            return response.json();
        })
        .then(data => {
            console.debug('previewCoupon: response data', data);
            if (!data.success) {
                // show preview error but don't block apply
                showMessage(data.message, 'danger');
                return data;
            }

            updateTotalsFromResponse(data);

            const finalEl = document.getElementById('final-total');
            if (finalEl) finalEl.textContent = formatRupees(totalsState.final);

            const discountEl = document.getElementById('discount-amount');
            if (discountEl) discountEl.textContent = formatRupees(totalsState.discount);

            const discountLabel = document.getElementById('discount-label');
            if (discountLabel && data.coupon_code) {
                const pct = data.discount_percentage ? ` (${data.discount_percentage}%)` : '';
                discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(data.coupon_code)}</strong>${pct}:`;
            }

            if (youSavedBanner) {
                youSavedBanner.textContent = 'You saved ' + formatRupees(totalsState.discount);
                youSavedBanner.style.display = totalsState.discount > 0 ? '' : 'none';
            }

            return data;
        })
        .catch(err => {
            console.error('previewCoupon error', err);
            return Promise.reject(err);
        });
    }

    // Initialize coupon UI event bindings. Call after DOM changes to re-wire.
    function initCouponUI() {
        const applyBtn = document.getElementById('apply-coupon-btn');
        const couponInput = document.getElementById('coupon-code-input');
        const removeBtn = document.getElementById('remove-coupon-btn');
        const couponsContainer = document.querySelector('.available-coupons');

        if (applyBtn && couponInput) {
            applyBtn.addEventListener('click', function() {
                const code = couponInput.value.trim().toUpperCase();
                if (!code) { showMessage('Please enter a coupon code', 'danger'); return; }
                // Immediate UI feedback: show applying placeholder in discount area
                const discountLabel = document.getElementById('discount-label');
                const discountEl = document.getElementById('discount-amount');
                const youSavedEl = document.getElementById('you-saved');
                // If this code matches a suggested coupon, show an immediate numeric estimate
                const suggestedCard = document.querySelector(`.coupon-suggestion[data-code="${code}"]`);
                if (suggestedCard) {
                    const est = computeEstimateFromCard(suggestedCard);
                    if (est) {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(estimate)</em>:`;
                        if (discountEl) discountEl.textContent = formatRupees(est.discount);
                        if (youSavedEl) { youSavedEl.textContent = 'You saved ' + formatRupees(est.discount); youSavedEl.style.display = ''; }
                    } else {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(applying&hellip;)</em>:`;
                        if (discountEl) discountEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
                        if (youSavedEl) { youSavedEl.textContent = 'Calculating...'; youSavedEl.style.display = ''; }
                    }
                } else {
                    if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(applying&hellip;)</em>:`;
                    if (discountEl) discountEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
                    if (youSavedEl) { youSavedEl.textContent = 'Calculating...'; youSavedEl.style.display = ''; }
                }

                applyBtn.innerHTML = 'Apply';
                applyCoupon(code);
            });
            couponInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); applyBtn.click(); }
            });

            // Debounced preview when typing codes that match suggestions
            let previewTimer = null;
            couponInput.addEventListener('input', function(e) {
                clearTimeout(previewTimer);
                const code = (couponInput.value || '').trim().toUpperCase();
                if (!code) return;
                previewTimer = setTimeout(() => {
                    // Find matching suggestion (case-insensitive)
                    const matching = Array.from(document.querySelectorAll('.coupon-suggestion')).find(c => (c.getAttribute('data-code') || '').toUpperCase() === code);
                    if (matching) {
                        // Call preview to show server-accurate values but do not persist
                        previewCoupon(code).catch(err => console.warn('Preview on input failed', err));
                    }
                }, 450);
            });
        }

        if (couponsContainer) {
            couponsContainer.addEventListener('click', function(e) {
                const btn = e.target.closest('.apply-suggested-coupon');
                if (btn) {
                    e.preventDefault();
                    const card = btn.closest('.coupon-suggestion');
                    if (!card) return;
                    const code = card.dataset.code;
                    // Immediate UI feedback for suggestion click — compute numeric estimate
                    const discountLabel = document.getElementById('discount-label');
                    const discountEl = document.getElementById('discount-amount');
                    const youSavedEl = document.getElementById('you-saved');
                    const est = computeEstimateFromCard(card);
                    if (est) {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(estimate)</em>:`;
                        if (discountEl) discountEl.textContent = formatRupees(est.discount);
                        if (youSavedEl) { youSavedEl.textContent = 'You saved ' + formatRupees(est.discount); youSavedEl.style.display = ''; }
                    } else {
                        if (discountLabel) discountLabel.innerHTML = `<i class="fas fa-tag me-1"></i>Coupon <strong>${escapeHtml(code)}</strong> <em>(applying&hellip;)</em>:`;
                        if (discountEl) discountEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
                        if (youSavedEl) { youSavedEl.textContent = 'Calculating...'; youSavedEl.style.display = ''; }
                    }
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    // Directly apply coupon on suggestion click (single request)
                    applyCoupon(code);
                    return;
                }
                const card = e.target.closest('.coupon-suggestion');
                if (card && !e.target.closest('button')) {
                    const code = card.dataset.code;
                    const inp = document.getElementById('coupon-code-input');
                    if (inp) { inp.value = code; inp.focus(); }
                }
            });
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                // Proceed immediately when user clicks Remove (no confirm dialog)
                console.debug('remove coupon: starting fetch');
                const formData = new FormData();
                appendShipping(formData);
                fetch('{% url "remove_coupon" %}', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => {
                    console.debug('remove coupon: fetch completed, status', response.status, 'url', response.url);
                    const ct = response.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) {
                        if (response.redirected || response.url.includes('{% url "login" %}')) {
                            // Don't use blocking alert(); show inline message and redirect
                            showMessage('Please login to remove coupons.', 'danger');
                            setTimeout(() => { window.location.href = '{% url "login" %}?next={% url "checkout" %}'; }, 900);
                            throw new Error('auth');
                        }
                        return response.text().then(text => { throw { name: 'ParseError', text }; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) { showMessage(data.message || 'Could not remove coupon', 'danger'); return; }

                    updateTotalsFromResponse(data);
                    totalsState.discount = 0;
                    updateTotalsDisplay();

                    const finalEl = document.getElementById('final-total');
                    if (finalEl) finalEl.textContent = formatRupees(totalsState.final);

                    const discountEl = document.getElementById('discount-amount'); if (discountEl) discountEl.textContent = formatRupees(0);
                    const discountLabel = document.getElementById('discount-label'); if (discountLabel) discountLabel.innerHTML = '';
                    if (youSavedBanner) youSavedBanner.style.display = 'none';

                    // Restore original coupon input area and re-bind handlers
                    const body = document.getElementById('coupon-input-body');
                    if (body) {
                        body.innerHTML = originalCouponBodyHTML;
                        initCouponUI();
                    }
                    if (data.force_refresh) {
                        try { setTimeout(() => { window.location.reload(); }, 700); } catch(e){}
                    }
                })
                .catch(err => { if (err.message === 'auth') return; console.error('Remove error', err); showMessage('Could not remove coupon', 'danger'); });
            });
        }
    }

    // Initialize handlers on first load
    initCouponUI();
});
</script>
<script>
(function() {
    const checkoutForm = document.getElementById('ajax-checkout-form');
    if (!checkoutForm) {
        return;
    }

    const placeOrderBtn = document.getElementById('place-order-btn');
    const btnText = document.getElementById('place-order-btn-text');
    const btnSpinner = document.getElementById('place-order-btn-spinner');
    const messageDiv = document.getElementById('checkout-message');
    const csrfInput = checkoutForm.querySelector('input[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfInput ? csrfInput.value : null;

    const createDraftUrl = "{% url 'create_draft_order' %}";
    const createPaymentTemplate = "{% url 'create_razorpay_payment' 0 %}";
    const verifyUrl = "{% url 'verify_razorpay_payment' %}";
    const confirmationTemplate = "{% url 'order_confirmation' 0 %}";

    const razorpayMethodConfig = {
        card: { card: true, upi: false, netbanking: false, wallet: false },
        upi: { card: false, upi: true, netbanking: false, wallet: false },
        netbanking: { card: false, upi: false, netbanking: true, wallet: false },
        wallet: { card: false, upi: false, netbanking: false, wallet: true }
    };

    function showCheckoutMessage(message, type = 'danger') {
        if (!messageDiv) return;
        if (!message) {
            messageDiv.innerHTML = '';
            return;
        }
        messageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    function setButtonState(disabled) {
        if (!placeOrderBtn) return;
        placeOrderBtn.disabled = disabled;
        if (btnText) btnText.style.display = disabled ? 'none' : '';
        if (btnSpinner) btnSpinner.style.display = disabled ? '' : 'none';
    }

    const upiQrSection = document.getElementById('upi-qr-section');
    const upiQrImage = document.getElementById('upi-qr-image');
    const upiQrUpiId = document.getElementById('upi-qr-upi-id');
    const upiPhonepeLink = document.getElementById('upi-phonepe-link');
    const upiGpayLink = document.getElementById('upi-gpay-link');
    const upiPaytmLink = document.getElementById('upi-paytm-link');

    function resolveCreatePaymentUrl(orderId) {
        return createPaymentTemplate.replace('0/', `${orderId}/`);
    }

    function resolveConfirmationUrl(orderId) {
        return confirmationTemplate.replace('0/', `${orderId}/`);
    }

    function hideUpiDetails() {
        if (upiQrSection) {
            upiQrSection.style.display = 'none';
        }
        if (upiQrImage) {
            upiQrImage.src = '';
        }
        if (upiQrUpiId) {
            upiQrUpiId.textContent = '';
        }
        if (upiPhonepeLink) upiPhonepeLink.href = '#';
        if (upiGpayLink) upiGpayLink.href = '#';
        if (upiPaytmLink) upiPaytmLink.href = '#';
    }

    function showUpiDetails(draftData) {
        if (!upiQrSection || !draftData) {
            return;
        }
        if (draftData.upi_qr && upiQrImage) {
            upiQrImage.src = `data:image/png;base64,${draftData.upi_qr}`;
        }
        if (upiQrUpiId) {
            upiQrUpiId.textContent = draftData.upi_id || '';
        }
        const apps = draftData.upi_apps || {};
        if (upiPhonepeLink) {
            upiPhonepeLink.href = apps.phonepe || '#';
        }
        if (upiGpayLink) {
            upiGpayLink.href = apps.googlepay || '#';
        }
        if (upiPaytmLink) {
            upiPaytmLink.href = apps.paytm || '#';
        }
        upiQrSection.style.display = 'block';
    }

    let razorpayLoaderPromise = null;
    function loadRazorpayScript() {
        if (!razorpayLoaderPromise) {
            razorpayLoaderPromise = new Promise((resolve, reject) => {
                if (window.Razorpay) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://checkout.razorpay.com/v1/checkout.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Razorpay script'));
                document.head.appendChild(script);
            });
        }
        return razorpayLoaderPromise;
    }

    async function verifyPayment(orderId, payload) {
        const response = await fetch(verifyUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Payment verification failed.');
        }
        window.location.href = resolveConfirmationUrl(orderId);
    }

    if (checkoutForm) {
        const paymentRadios = checkoutForm.querySelectorAll('input[name="payment_method"]');
        paymentRadios.forEach((input) => {
            input.addEventListener('change', (event) => {
                if (event.target.value !== 'upi') {
                    hideUpiDetails();
                }
            });
        });
    }

    checkoutForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setButtonState(true);
        showCheckoutMessage('');
        hideUpiDetails();

        const formData = new FormData(checkoutForm);
        const paymentMethod = formData.get('payment_method');
        if (!paymentMethod) {
            showCheckoutMessage('Please select a payment method.');
            setButtonState(false);
            return;
        }

        try {
            const draftResp = await fetch(createDraftUrl, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });
            const draftJson = await draftResp.json();
            if (!draftResp.ok || !draftJson.order_id) {
                throw new Error(draftJson.error || 'Failed to create order.');
            }

            if (paymentMethod === 'upi') {
                showUpiDetails(draftJson);
            }

            const paymentResp = await fetch(resolveCreatePaymentUrl(draftJson.order_id), {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });
            const paymentJson = await paymentResp.json();
            if (!paymentResp.ok) {
                throw new Error(paymentJson.error || 'Failed to initiate payment gateway.');
            }

            const rzpOrderId = paymentJson.razorpay_order_id;
            const rzpKey = paymentJson.razorpay_key_id || paymentJson.key_id || paymentJson.razorpay_key;
            const amountPaise = paymentJson.amount || paymentJson.amount_paise;
            if (!rzpOrderId || !rzpKey) {
                throw new Error('Payment gateway returned an incomplete response.');
            }

            await loadRazorpayScript();

            const methodConfig = Object.assign({ card: false, upi: false, netbanking: false, wallet: false }, razorpayMethodConfig[paymentMethod] || {});

            const config = (function() {
                if (paymentMethod !== 'upi') {
                    return undefined;
                }
                return {
                    display: {
                        blocks: {
                            upi: {
                                name: 'Pay via UPI',
                                instruments: [
                                    { method: 'upi' }
                                ]
                            }
                        },
                        sequence: ['upi'],
                        preferences: {
                            show_default_blocks: false
                        }
                    }
                };
            })();

            const options = Object.assign({
                key: rzpKey,
                order_id: rzpOrderId,
                amount: amountPaise,
                currency: paymentJson.currency || 'INR',
                name: "{{ SITE_NAME|escapejs }}",
                description: `Order ${draftJson.order_number || draftJson.order_id}`,
                method: methodConfig,
                theme: { color: '#1E88E5' },
                notes: {
                    order_number: draftJson.order_number,
                    payment_method: paymentMethod
                },
                prefill: {
                    name: "{{ user.get_full_name|default:user.username|default:''|escapejs }}",
                    email: "{{ user.email|default:''|escapejs }}",
                    contact: document.querySelector('input[name="phone_number"]') ? document.querySelector('input[name="phone_number"]').value : "{{ user.phone_number|default:''|escapejs }}"
                },
                handler: async (response) => {
                    try {
                        await verifyPayment(draftJson.order_id, {
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            order_id: draftJson.order_id
                        });
                    } catch (err) {
                        showCheckoutMessage(err.message || 'Payment verification failed.');
                        setButtonState(false);
                    }
                },
                modal: {
                    ondismiss: function() {
                        showCheckoutMessage('Payment flow cancelled by user.', 'warning');
                        setButtonState(false);
                    }
                }
            }, config ? { config } : {});

            const rzp = new window.Razorpay(options);
            rzp.on('payment.failed', function(eventInfo) {
                const err = eventInfo && eventInfo.error ? eventInfo.error : {};
                const message = err.description || err.reason || 'Payment failed. Please try again.';
                showCheckoutMessage(message);
                setButtonState(false);
            });
            rzp.open();
        } catch (error) {
            console.error('Checkout error', error);
            showCheckoutMessage(error.message || 'Unable to process payment. Please try again.');
            setButtonState(false);
        }
    });
})();
</script>
{% endblock %}
