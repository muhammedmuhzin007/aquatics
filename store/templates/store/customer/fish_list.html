{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<section class="section">
    <div class="container-fluid">
        <h2 class="section-heading">Fish Collection</h2>
        
        <form id="fish-filter-form" method="get" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-8 col-lg-9">
                    <label for="live-search" class="form-label text-muted mb-1">Search</label>
                    <input id="live-search" type="text" class="form-control form-control-lg search-large" name="search" value="{{ search_query }}"
                           placeholder="Search by name, description, breed..." autocomplete="off">
                </div>
                <div class="col-12 col-md-4 col-lg-3 col-xl-3">
                    <label for="category-filter" class="form-label text-muted mb-1">Category</label>
                    <select id="category-filter" name="category" class="form-select form-select-lg">
                        <option value=""{% if not category_filter %} selected{% endif %}>All categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}"{% if category_filter and category.id|stringformat:"s" == category_filter|stringformat:"s" %} selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>

        <div id="fish-results">
            {% include 'store/customer/_fish_grid.html' %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const searchInput = document.getElementById('live-search');
    const resultsContainer = document.getElementById('fish-results');
    const categorySelect = document.getElementById('category-filter');
    const filterForm = document.getElementById('fish-filter-form');
    let timeout = null;

    function fetchResults(query, category){
        const params = new URLSearchParams();
        if (query) {
            params.set('search', query);
        }
        if (category) {
            params.set('category', category);
        }
        const queryString = params.toString();
        const url = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(resp => resp.json())
        .then(data => {
            if (data && data.html !== undefined) {
                insertResults(data.html);
                if (window.history && window.history.replaceState) {
                    window.history.replaceState(null, '', url);
                }
            }
        })
        .catch(err => {
            console.error('Live search error', err);
        });
    }

    if (searchInput) {
        searchInput.addEventListener('input', function(e){
            const q = this.value.trim();
            // debounce
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const category = categorySelect ? categorySelect.value : '';
                fetchResults(q, category);
            }, 300);
        });
    }

    if (categorySelect) {
        categorySelect.addEventListener('change', function(){
            const currentSearch = searchInput ? searchInput.value.trim() : '';
            fetchResults(currentSearch, this.value);
        });
    }

    if (filterForm) {
        filterForm.addEventListener('submit', function(e){
            e.preventDefault();
            const q = searchInput ? searchInput.value.trim() : '';
            const category = categorySelect ? categorySelect.value : '';
            fetchResults(q, category);
        });
    }

    // Smoothly animate new results when received
    function insertResults(html) {
        resultsContainer.innerHTML = html;
        resultsContainer.classList.remove('fade-in');
        // force reflow to restart animation
        void resultsContainer.offsetWidth;
        resultsContainer.classList.add('fade-in');
    }
});
</script>
{% endblock %}
