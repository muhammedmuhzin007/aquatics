{% extends 'store/base.html' %}
{% load static %}
{% load currency %}

{% block content %}
<section class="section manage-fish-minimal">
    <div class="container-fluid">
        <style>
            /* Dark mode specific overrides */
            html[data-theme='dark'] .manage-fish-minimal .card.admin-card-light {
                background: var(--card-bg) !important;
                border: 1px solid var(--border-color) !important;
            }
            html[data-theme='dark'] .manage-fish-minimal .card.admin-card-light .card-body { background: transparent !important; }
            html[data-theme='dark'] .manage-fish-minimal table.table { background: transparent !important; }
            html[data-theme='dark'] .manage-fish-minimal .table>:not(caption)>*>*:not(.btn):not(.badge) { 
                background: transparent !important; 
                box-shadow: none !important;
                color: #FFFFFF !important;
            }
            html[data-theme='dark'] .manage-fish-minimal thead th {
                background: rgba(25,40,60,0.65) !important;
                color: #FFFFFF !important;
                border-color: var(--border-color) !important;
                font-weight: 600 !important;
            }
            html[data-theme='dark'] .manage-fish-minimal tbody tr { background: rgba(20,30,45,0.55) !important; transition: background .18s ease; }
            html[data-theme='dark'] .manage-fish-minimal tbody tr:nth-child(odd) { background: rgba(25,40,60,0.55) !important; }
            html[data-theme='dark'] .manage-fish-minimal tbody tr:hover { background: rgba(40,80,140,0.55) !important; }
            html[data-theme='dark'] .manage-fish-minimal td, html[data-theme='dark'] .manage-fish-minimal th { color: #FFFFFF !important; border-color: var(--border-color) !important; }
            html[data-theme='dark'] .manage-fish-minimal .admin-text-black { color: #FFFFFF !important; }
            html[data-theme='dark'] .manage-fish-minimal .empty-state .fas { color: var(--text-white); }
            html[data-theme='dark'] .manage-fish-minimal .badge { box-shadow: 0 0 0 1px rgba(0,0,0,0.25); }
            html[data-theme='dark'] .manage-fish-minimal .table td strong { color: #FFFFFF !important; }
            html[data-theme='dark'] .manage-fish-minimal .table td, html[data-theme='dark'] .manage-fish-minimal .table th { font-weight: 500; color: #FFFFFF !important; }
            html[data-theme='dark'] .manage-fish-minimal a.btn.btn-danger.btn-sm { background: #d32f2f !important; border-color: #d32f2f !important; color: #fff !important; }
            html[data-theme='dark'] .manage-fish-minimal a.btn.btn-danger.btn-sm:hover { background: #b71c1c !important; border-color: #b71c1c !important; }

            /* Light mode refinements */
            html[data-theme='light'] .manage-fish-minimal .card.admin-card-light { background: var(--light-card) !important; border: 1px solid var(--light-border) !important; }
            html[data-theme='light'] .manage-fish-minimal .table { background: var(--light-card) !important; }
            html[data-theme='light'] .manage-fish-minimal thead th { background: rgba(25,118,210,0.08) !important; color: var(--light-text) !important; border-color: var(--light-border) !important; font-weight:600 !important; }
            html[data-theme='light'] .manage-fish-minimal tbody tr { background: var(--light-card) !important; }
            html[data-theme='light'] .manage-fish-minimal tbody tr:nth-child(even) { background: rgba(26,35,50,0.03) !important; }
            html[data-theme='light'] .manage-fish-minimal tbody tr:hover { background: rgba(25,118,210,0.05) !important; }
            html[data-theme='light'] .manage-fish-minimal td, html[data-theme='light'] .manage-fish-minimal th { color: var(--light-text-soft) !important; border-color: var(--light-border) !important; }
            html[data-theme='light'] .manage-fish-minimal td strong { color: var(--light-text) !important; }
            html[data-theme='light'] .manage-fish-minimal .badge.bg-success { background: rgba(76,175,80,0.15)!important; color:#2e7d32!important; border-color: rgba(76,175,80,0.3)!important; }
            html[data-theme='light'] .manage-fish-minimal .badge.bg-danger { background: rgba(198,40,40,0.15)!important; color:#c62828!important; border-color: rgba(198,40,40,0.3)!important; }
            html[data-theme='light'] .manage-fish-minimal a.btn.btn-danger.btn-sm { background: transparent !important; color: #c62828 !important; border:1px solid #c62828 !important; }
            html[data-theme='light'] .manage-fish-minimal a.btn.btn-danger.btn-sm:hover { background:#c62828 !important; color:#fff !important; }

            /* Themed form controls rely on global styles; only adjust border radius */
            .manage-fish-minimal .form-control, .manage-fish-minimal .form-select { border-radius:6px; height: auto; padding: 0.5rem 0.75rem; line-height: 1.5; }
            html[data-theme='light'] .manage-fish-minimal .form-control, html[data-theme='light'] .manage-fish-minimal .form-select { color: var(--light-text) !important; }
            html[data-theme='dark'] .manage-fish-minimal .form-control, html[data-theme='dark'] .manage-fish-minimal .form-select { color: #FFFFFF !important; }
            html[data-theme='light'] .manage-fish-minimal .form-control::placeholder { color: var(--light-text-soft)!important; opacity:.7; }
            html[data-theme='dark'] .manage-fish-minimal .form-control::placeholder { color: rgba(255,255,255,0.6)!important; }
            /* Ensure select option text is clearly visible in light mode */
            html[data-theme='light'] .manage-fish-minimal select.form-select { color: #111827 !important; }
            html[data-theme='light'] .manage-fish-minimal select.form-select option { color: #111827 !important; }

            /* Keep table layout on small screens: allow horizontal scroll instead of card conversion */
            .manage-table-scroll { width: 100%; overflow-x: auto; }
            .manage-table-scroll table { width: 100%; min-width: 0; table-layout: auto; }
            .manage-table-scroll table td, .manage-table-scroll table th { word-break: break-word; }
            /* Compact staff UI adjustments to match admin/customer sizing */
            .manage-fish-minimal .section-heading { font-size: 1.125rem; letter-spacing: 0.02em; }
            .manage-fish-minimal .card.admin-card-light .card-body { padding: 0.6rem 0.75rem; }
            .manage-fish-minimal .table { margin-bottom: 0; }
            .manage-fish-minimal .table td, .manage-fish-minimal .table th { padding: 0.45rem 0.6rem; font-size: 0.92rem; }
            .manage-fish-minimal .form-control { padding: 0.4rem 0.6rem; font-size: 0.95rem; }
            .manage-fish-minimal .btn { padding: 0.32rem 0.6rem; font-size: 0.9rem; }
            .manage-fish-minimal .btn.btn-success, .manage-fish-minimal .btn.btn-primary { font-size: 0.95rem; }
            /* Slightly smaller modal content */
            .manage-fish-minimal .modal-content { font-size: 0.95rem; }
        </style>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-heading" style="margin-bottom: 0;">Manage Fishes</h2>
            <div class="d-flex gap-2">
                <a href="{% url 'add_fish' %}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Add New Fish
                </a>
                <a href="{% url 'admin_add_combo' %}" class="btn btn-primary">
                    <i class="fas fa-layer-group"></i> Add Combo
                </a>
            </div>
        </div>

        <div class="row g-3 align-items-end mb-4">
            <div class="col-lg-6 col-md-12">
                <label class="form-label admin-text-black mb-1">Search</label>
                <input id="staff-fish-search" type="text" class="form-control" name="search" value="{{ search_query }}" placeholder="Search fishes...">
            </div>
            <div class="col-lg-4 col-md-6">
                <label class="form-label admin-text-black mb-1">Category</label>
                <select id="staff-fish-category" class="form-select" name="category">
                    <option value="">All</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" title="{{ cat.name }} ({{ cat.fish_count }})" {% if category_id == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }} ({{ cat.fish_count }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label admin-text-black mb-1">Availability</label>
                <select id="staff-fish-availability" class="form-select" name="availability">
                    <option value="">All statuses</option>
                    <option value="available" {% if availability == 'available' %}selected{% endif %}>Active</option>
                    <option value="unavailable" {% if availability == 'unavailable' %}selected{% endif %}>Inactive</option>
                    <option value="in_stock" {% if availability == 'in_stock' %}selected{% endif %}>In stock</option>
                    <option value="out_of_stock" {% if availability == 'out_of_stock' %}selected{% endif %}>Out of stock</option>
                </select>
            </div>
        </div>

        <div id="fish-table-container">
            {% include 'store/staff/_fish_table.html' %}
            {% if not fishes %}
            {% include 'store/staff/_fish_empty.html' %}
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}
{% block extra_js %}
<script>
(() => {
    const input = document.getElementById('staff-fish-search');
    const categorySelect = document.getElementById('staff-fish-category');
    const availabilitySelect = document.getElementById('staff-fish-availability');
    if (!input) return;

    let t = null;
    const delay = 300;
    function buildQuery(){
        const params = new URLSearchParams();
        const q = input.value.trim();
        if (q) params.set('search', q);
        if (categorySelect && categorySelect.value) params.set('category', categorySelect.value);
        if (availabilitySelect && availabilitySelect.value) params.set('availability', availabilitySelect.value);
        return params;
    }

    async function doSearch(){
        const url = new URL(window.location.href);
        const params = buildQuery();
        url.search = params.toString();
        try{
            const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
            if (!resp.ok) return;
            const data = await resp.json();
            const container = document.getElementById('fish-table-container');
            if (container && data.html !== undefined){
                container.innerHTML = data.html;
            }
        }catch(err){ console.error('Fish search failed', err); }
    }

    input.addEventListener('input', (e)=>{
        clearTimeout(t);
        t = setTimeout(()=> doSearch(), delay);
    });

    input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
            e.preventDefault();
            clearTimeout(t);
            doSearch();
        }
    });

    [categorySelect, availabilitySelect].forEach((el)=>{
        if (!el) return;
        el.addEventListener('change', ()=>{
            clearTimeout(t);
            doSearch();
        });
    });
})();
</script>
{% endblock %}
