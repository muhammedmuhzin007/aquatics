{% extends 'store/base.html' %}
{% load currency %}

{% block content %}
<section class="section manage-fish-minimal">
    <div class="container-fluid">
        <style>
            /* Dark mode specific overrides */
            html[data-theme='dark'] .manage-fish-minimal .card.admin-card-light {
                background: var(--card-bg) !important;
                border: 1px solid var(--border-color) !important;
            }
            html[data-theme='dark'] .manage-fish-minimal .card.admin-card-light .card-body { background: transparent !important; }
            html[data-theme='dark'] .manage-fish-minimal table.table { background: transparent !important; }
            html[data-theme='dark'] .manage-fish-minimal .table>:not(caption)>*>*:not(.btn):not(.badge) { 
                background: transparent !important; 
                box-shadow: none !important;
                color: #FFFFFF !important;
            }
            html[data-theme='dark'] .manage-fish-minimal thead th {
                background: rgba(25,40,60,0.65) !important;
                color: #FFFFFF !important;
                border-color: var(--border-color) !important;
                font-weight: 600 !important;
            }
            html[data-theme='dark'] .manage-fish-minimal tbody tr { background: rgba(20,30,45,0.55) !important; transition: background .18s ease; }
            html[data-theme='dark'] .manage-fish-minimal tbody tr:nth-child(odd) { background: rgba(25,40,60,0.55) !important; }
            html[data-theme='dark'] .manage-fish-minimal tbody tr:hover { background: rgba(40,80,140,0.55) !important; }
            html[data-theme='dark'] .manage-fish-minimal td, html[data-theme='dark'] .manage-fish-minimal th { color: #FFFFFF !important; border-color: var(--border-color) !important; }
            html[data-theme='dark'] .manage-fish-minimal .admin-text-black { color: #FFFFFF !important; }
            html[data-theme='dark'] .manage-fish-minimal .empty-state .fas { color: var(--text-white); }
            html[data-theme='dark'] .manage-fish-minimal .badge { box-shadow: 0 0 0 1px rgba(0,0,0,0.25); }
            html[data-theme='dark'] .manage-fish-minimal .table td strong { color: #FFFFFF !important; }
            html[data-theme='dark'] .manage-fish-minimal .table td, html[data-theme='dark'] .manage-fish-minimal .table th { font-weight: 500; color: #FFFFFF !important; }
            html[data-theme='dark'] .manage-fish-minimal a.btn.btn-danger.btn-sm { background: #d32f2f !important; border-color: #d32f2f !important; color: #fff !important; }
            html[data-theme='dark'] .manage-fish-minimal a.btn.btn-danger.btn-sm:hover { background: #b71c1c !important; border-color: #b71c1c !important; }

            /* Light mode refinements */
            html[data-theme='light'] .manage-fish-minimal .card.admin-card-light { background: var(--light-card) !important; border: 1px solid var(--light-border) !important; }
            html[data-theme='light'] .manage-fish-minimal .table { background: var(--light-card) !important; }
            html[data-theme='light'] .manage-fish-minimal thead th { background: rgba(25,118,210,0.08) !important; color: var(--light-text) !important; border-color: var(--light-border) !important; font-weight:600 !important; }
            html[data-theme='light'] .manage-fish-minimal tbody tr { background: var(--light-card) !important; }
            html[data-theme='light'] .manage-fish-minimal tbody tr:nth-child(even) { background: rgba(26,35,50,0.03) !important; }
            html[data-theme='light'] .manage-fish-minimal tbody tr:hover { background: rgba(25,118,210,0.05) !important; }
            html[data-theme='light'] .manage-fish-minimal td, html[data-theme='light'] .manage-fish-minimal th { color: var(--light-text-soft) !important; border-color: var(--light-border) !important; }
            html[data-theme='light'] .manage-fish-minimal td strong { color: var(--light-text) !important; }
            html[data-theme='light'] .manage-fish-minimal .badge.bg-success { background: rgba(76,175,80,0.15)!important; color:#2e7d32!important; border-color: rgba(76,175,80,0.3)!important; }
            html[data-theme='light'] .manage-fish-minimal .badge.bg-danger { background: rgba(198,40,40,0.15)!important; color:#c62828!important; border-color: rgba(198,40,40,0.3)!important; }
            html[data-theme='light'] .manage-fish-minimal a.btn.btn-danger.btn-sm { background: transparent !important; color: #c62828 !important; border:1px solid #c62828 !important; }
            html[data-theme='light'] .manage-fish-minimal a.btn.btn-danger.btn-sm:hover { background:#c62828 !important; color:#fff !important; }

            /* Themed form controls rely on global styles; only adjust border radius */
            .manage-fish-minimal .form-control, .manage-fish-minimal .form-select { border-radius:6px; }
            html[data-theme='light'] .manage-fish-minimal .form-control::placeholder { color: var(--light-text-soft)!important; opacity:.7; }
            html[data-theme='dark'] .manage-fish-minimal .form-control::placeholder { color: rgba(255,255,255,0.6)!important; }

            /* Responsive table improvements (already globally scrollable) */
            @media (max-width: 576px) {
                .manage-fish-minimal table.table thead { display: none; }
                .manage-fish-minimal table.table tbody tr { display: block; margin-bottom: 12px; border:1px solid var(--border-color); border-radius:8px; padding:8px 10px; }
                html[data-theme='light'] .manage-fish-minimal table.table tbody tr { border-color: var(--light-border); }
                .manage-fish-minimal table.table tbody td { display: flex; justify-content: space-between; align-items: center; padding:6px 8px; font-size:0.85rem; }
                .manage-fish-minimal table.table tbody td:before { content: attr(data-label); font-weight:600; opacity:.8; margin-right:8px; }
            }
        </style>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-heading" style="margin-bottom: 0;">Manage Fishes</h2>
            <a href="{% url 'add_fish' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Add New Fish
            </a>
        </div>

        <div class="search-container mb-4">
            <div class="row g-3">
                <div class="col-md-12">
                    <input id="staff-fish-search" type="text" class="form-control" name="search" value="{{ search_query }}" placeholder="Search fishes...">
                </div>
            </div>
        </div>

        <div id="fish-table-container">
            {% include 'store/staff/_fish_table.html' %}
            {% if not fishes %}
            <div class="empty-state">
                <i class="fas fa-fish"></i>
                <h3>No fishes found</h3>
                <a href="{% url 'add_fish' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> Add First Fish
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}
{% block extra_js %}
<script>
(() => {
    const input = document.getElementById('staff-fish-search');
    if (!input) return;

    let t = null;
    const delay = 300;
    async function doSearch(q){
        const url = new URL(window.location.href);
        url.searchParams.set('search', q || '');
        try{
            const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
            if (!resp.ok) return;
            const data = await resp.json();
            const container = document.getElementById('fish-table-container');
            if (container && data.html !== undefined){
                container.innerHTML = data.html;
            }
        }catch(err){ console.error('Fish search failed', err); }
    }

    input.addEventListener('input', (e)=>{
        clearTimeout(t);
        t = setTimeout(()=> doSearch(e.target.value.trim()), delay);
    });

    input.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
            e.preventDefault();
            clearTimeout(t);
            doSearch(input.value.trim());
        }
    });
})();
</script>
{% endblock %}
